<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Join Referral Program - Crown Trade Academy</title>

  <style>
    :root {
      --dark-brown: #3A2D28;
      --muted-rose: #A48374;
      --warm-beige: #CBAD8D;
      --light-taupe: #D1C7BD;
      --off-white: #EBE3DB;
      --cream-white: #F1EDE6;
      --gold-accent: #D4AF37;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--off-white) 0%, var(--cream-white) 100%);
      color: var(--dark-brown);
      line-height:1.6;
      min-height:100vh;
    }
    .premium-header{
      background: linear-gradient(135deg, var(--dark-brown) 0%, #2A1F1A 100%);
      color: var(--cream-white);
      padding:1.2rem 0;
      box-shadow:0 4px 20px rgba(58,45,40,0.1);
      border-bottom:3px solid var(--gold-accent);
    }
    .premium-nav{ display:flex; justify-content:space-between; align-items:center; max-width:1200px; margin:0 auto; padding:0 2rem; }
    .logo{ font-size:2rem; font-weight:700; color:var(--warm-beige); text-decoration:none; }
    .nav-links{ display:flex; gap:2rem; list-style:none; }
    .nav-links a{ color:var(--cream-white); text-decoration:none; font-weight:500; }
    .premium-container{ max-width:1200px; margin:0 auto; padding:0 20px; }
    .premium-card{
      background: linear-gradient(135deg, var(--cream-white) 0%, #FFFFFF 100%);
      border:1px solid var(--light-taupe);
      border-radius:20px;
      padding:2.5rem;
      margin:1.5rem 0;
      position:relative;
      overflow:hidden;
      box-shadow:0 15px 40px rgba(58,45,40,0.08);
    }
    .premium-card::before{ content:''; position:absolute; top:0; left:0; right:0; height:4px;
      background: linear-gradient(90deg, var(--gold-accent), var(--warm-beige), var(--gold-accent)); }
    .registration-steps{ display:flex; justify-content:center; gap:1rem; margin-bottom:1.5rem; }
    .step{ text-align:center; padding:1rem; border-radius:10px; background:var(--off-white); flex:1; max-width:150px; }
    .step.active{ background:var(--warm-beige); color:var(--dark-brown); font-weight:600; }
    .step-number{ width:30px; height:30px; border-radius:50%; background:var(--muted-rose); color:white; display:flex; align-items:center; justify-content:center; margin:0 auto .5rem; }
    .form-group{ margin-bottom:1.25rem; }
    .form-label{ display:block; margin-bottom:.5rem; font-weight:600; color:var(--dark-brown); }
    .form-control{ width:100%; padding:1rem; border:2px solid var(--light-taupe); border-radius:8px; background:var(--off-white); color:var(--dark-brown); font-size:1rem; font-family:inherit; }
    .btn-premium{
      background: linear-gradient(135deg, var(--dark-brown) 0%, #4A3A32 100%);
      color: var(--cream-white); border:none; padding:1rem 2rem; border-radius:12px; font-weight:700; cursor:pointer; width:100%;
    }
    .meta-note{ color:var(--muted-rose); font-size:0.9rem; text-align:center; margin-top:1rem; }
    .file-hint{ font-size:0.9rem; color:var(--muted-rose); margin-top:.4rem; }
    .upload-progress { height:8px; background:var(--off-white); border-radius:8px; overflow:hidden; margin-top:.6rem; display:none; }
    .upload-progress > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--warm-beige),var(--gold-accent)); transition:width .2s ease; }
    .small { font-size:0.85rem; color:var(--muted-rose); }
    .premium-footer{ background: linear-gradient(135deg, var(--dark-brown) 0%, #2A1F1A 100%); color: var(--cream-white); padding:3rem 0 2rem; margin-top:4rem; border-top:3px solid var(--gold-accent); }
    .footer-content{ max-width:1200px; margin:0 auto; padding:0 2rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:2rem; }
  </style>
</head>
<body>
  <header class="premium-header">
    <nav class="premium-nav">
      <a href="index.html" class="logo">Crown Trade Academy</a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="login.html">Client Login</a></li>
      </ul>
    </nav>
  </header>

  <section class="premium-container" style="padding:2rem 0; min-height:80vh;">
    <div class="registration-steps" aria-hidden>
      <div class="step active"><div class="step-number">1</div><div>Create Account</div></div>
      <div class="step"><div class="step-number">2</div><div>Pay KES 500</div></div>
      <div class="step"><div class="step-number">3</div><div>Wait Approval</div></div>
      <div class="step"><div class="step-number">4</div><div>Start Earning</div></div>
    </div>

    <div class="premium-card" style="max-width:600px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:1.6rem;">
        <h1 style="color:var(--dark-brown);margin-bottom:.4rem;">Join Referral Program</h1>
        <p style="color:var(--muted-rose);">Register, upload payment proof, and submit for admin approval.</p>
      </div>

      <!-- === Referral Form === -->
      <form id="referralRegisterForm" enctype="multipart/form-data" novalidate>
        <div class="form-group">
          <label class="form-label" for="fullName">Full Name</label>
          <input id="fullName" class="form-control" type="text" required placeholder="Your full name">
        </div>

        <div class="form-group">
          <label class="form-label" for="email">Email Address</label>
          <input id="email" class="form-control" type="email" required placeholder="you@example.com">
        </div>

        <div class="form-group">
          <label class="form-label" for="phone">Phone Number</label>
          <input id="phone" class="form-control" type="tel" required placeholder="+254 7XX XXX XXX">
        </div>

        <div class="form-group">
          <label class="form-label" for="password">Create Password</label>
          <input id="password" class="form-control" type="password" required minlength="6" placeholder="Minimum 6 characters">
        </div>

        <div class="form-group">
          <label class="form-label" for="confirmPassword">Confirm Password</label>
          <input id="confirmPassword" class="form-control" type="password" required placeholder="Re-enter password">
        </div>

        <!-- === Payment Proof Section === -->
        <div class="form-group">
          <label class="form-label" for="proof">Upload Payment Proof (MPesa Screenshot)</label>
          <input id="proof" class="form-control" type="file" accept="image/*" required>
          <div class="file-hint small">Max 6 MB. JPG or PNG screenshot of MPesa payment.</div>

          <div class="upload-progress" id="uploadProgress">
            <i id="uploadBar"></i>
          </div>
        </div>

        <!-- I Have Paid Confirmation -->
        <div class="form-group">
          <label style="display:flex; gap:.6rem; align-items:flex-start;">
            <input id="paidConfirmation" type="checkbox" style="accent-color:var(--dark-brown); margin-top:.35rem;" required>
            <span style="color:var(--dark-brown); font-size:.95rem;">
              ✅ I confirm I have paid KES 500 registration fee via MPesa
            </span>
          </label>
        </div>

        <div class="form-group" style="margin-top:1rem;">
          <label style="display:flex; gap:.6rem; align-items:flex-start;">
            <input id="agree" type="checkbox" style="accent-color:var(--dark-brown); margin-top:.35rem;" required>
            <span style="color:var(--dark-brown); font-size:.95rem;">
              I agree to the terms and understand I'll earn KES 300 per successful referral
            </span>
          </label>
        </div>

        <button type="submit" class="btn-premium" id="submitBtn">Submit for Approval →</button>
        <p class="meta-note">Already have an account? <a href="login.html" style="color:var(--warm-beige);">Login here</a></p>
      </form>
    </div>
  </section>

  <footer class="premium-footer">
    <div class="footer-content">
      <div><h3>Referral Program</h3><p>Start earning today</p><p>Email: crowntradeacademy@gmail.com</p></div>
      <div><h3>Earnings</h3><p>KES 300 per referral</p><p>Minimum withdrawal: KES 100</p></div>
    </div>
    <div style="text-align:center;margin-top:2rem;padding-top:2rem;border-top:1px solid var(--muted-rose);">&copy; 2024 Crown Trade Academy. All rights reserved.</div>
  </footer>

  <!-- === SIMPLE FIREBASE SETUP === -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAa16xt5nZTIVNp_NRSZm388XT4hIVoF9k",
      authDomain: "crowntradeacademy-67be1.firebaseapp.com",
      projectId: "crowntradeacademy-67be1",
      storageBucket: "crowntradeacademy-67be1.firebasestorage.app",
      messagingSenderId: "943453710285",
      appId: "1:943453710285:web:7f122e722f03f3854d4684",
      measurementId: "G-7XESVW5YWL"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    console.log("Firebase initialized:", app);

    document.getElementById('referralRegisterForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const fullName = document.getElementById('fullName').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const phone = document.getElementById('phone').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const paidConfirmation = document.getElementById('paidConfirmation').checked;
      const agree = document.getElementById('agree').checked;
      const file = document.getElementById('proof').files[0];

      // Validation
      if (!fullName || !email || !phone || !password || !confirmPassword) {
        alert('Please fill out all required fields.');
        return;
      }
      if (password !== confirmPassword) {
        alert('Passwords do not match.');
        return;
      }
      if (password.length < 6) {
        alert('Password must be at least 6 characters.');
        return;
      }
      if (!paidConfirmation) {
        alert('Please confirm that you have paid KES 500.');
        return;
      }
      if (!agree) {
        alert('You must agree to the terms to continue.');
        return;
      }
      if (!file) {
        alert('Please upload MPesa payment screenshot.');
        return;
      }
      if (file.size > 6 * 1024 * 1024) {
        alert('File too large. Max size is 6 MB.');
        return;
      }
      if (!['image/jpeg','image/png','image/jpg'].includes(file.type)) {
        alert('Please upload JPG or PNG image only.');
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        console.log('Starting registration process...');

        // 1. Create user account
        console.log('Creating user account...');
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        console.log('User created:', user.uid);

        // 2. Upload file to storage
        console.log('Uploading file...');
        const storageRef = storage.ref();
        const fileRef = storageRef.child('paymentProofs/' + user.uid + '/' + Date.now() + '_' + file.name);
        
        const uploadTask = fileRef.put(file);
        
        // Show progress
        document.getElementById('uploadProgress').style.display = 'block';
        
        uploadTask.on('state_changed',
          (snapshot) => {
            // Progress
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById('uploadBar').style.width = progress + '%';
          },
          (error) => {
            throw error;
          },
          async () => {
            // Upload completed
            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
            console.log('File available at:', downloadURL);

            // 3. Save application to Firestore
            console.log('Saving to Firestore...');
            await db.collection('referralApplications').add({
              uid: user.uid,
              fullName: fullName,
              email: email,
              phone: phone,
              paymentProofUrl: downloadURL,
              paymentProofPath: uploadTask.snapshot.ref.fullPath,
              status: 'pending',
              paidConfirmation: true,
              registeredAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            console.log('Application saved successfully!');

            // Store user info
            localStorage.setItem('referralUid', user.uid);
            localStorage.setItem('userEmail', email);

            // Success
            alert('✅ Registration submitted successfully! Awaiting admin approval.');
            window.location.href = 'referral-pending.html';
          }
        );

      } catch (error) {
        console.error('Registration error:', error);
        
        let errorMessage = 'Registration failed. Please try again.';
        
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'This email is already registered. Please use a different email.';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Invalid email address format.';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'Password is too weak. Use at least 6 characters.';
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = 'Network error. Please check your internet connection.';
        }
        
        alert('Error: ' + errorMessage);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit for Approval →';
        document.getElementById('uploadProgress').style.display = 'none';
      }
    });
  </script>
</body>
</html>
