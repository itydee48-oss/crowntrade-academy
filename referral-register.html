<script>
let currentStep = 1;
let applicationData = {
    fullName: '',
    email: '',
    phone: '',
    proofBase64: ''
};

// Capture referral from URL
const urlParams = new URLSearchParams(window.location.search);
const referrerCode = urlParams.get('ref');
if(referrerCode){
    sessionStorage.setItem('referrerCode', referrerCode);
}

// Step navigation
function nextStep(step) {
    document.getElementById(`step${currentStep}`).classList.remove('active');
    document.querySelectorAll('.step')[currentStep - 1].classList.remove('active');

    document.getElementById(`step${step}`).classList.add('active');
    document.querySelectorAll('.step')[step - 1].classList.add('active');

    for (let i = 0; i < step - 1; i++) {
        document.querySelectorAll('.step')[i].classList.add('completed');
    }

    currentStep = step;

    if (step === 3) {
        updateApplicationSummary();
    }
}

function prevStep(step) {
    document.getElementById(`step${currentStep}`).classList.remove('active');
    document.querySelectorAll('.step')[currentStep - 1].classList.remove('active');

    document.getElementById(`step${step}`).classList.add('active');
    document.querySelectorAll('.step')[step - 1].classList.add('active');

    currentStep = step;
}

// Step 1 validation
function validateStep1() {
    const fullName = document.getElementById('fullName').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();

    if (!fullName) { alert('Please enter your full name'); return; }
    if (!email) { alert('Please enter your email'); return; }
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) { alert('Enter a valid email'); return; }
    if (!phone) { alert('Please enter your phone number'); return; }

    const applications = JSON.parse(localStorage.getItem('referral_applications') || '[]');
    if (applications.find(app => app.email === email)) {
        alert('An application with this email already exists.');
        return;
    }

    applicationData.fullName = fullName;
    applicationData.email = email;
    applicationData.phone = phone;

    nextStep(2);
}

// Step 2 validation
function validateStep2() {
    if (!applicationData.proofBase64) {
        alert('Please upload your payment proof.');
        return;
    }
    nextStep(3);
}

// File upload
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!file.type.match('image.*')) { alert('Select PNG/JPG image'); return; }
    if (file.size > 5*1024*1024) { alert('File must be <5MB'); return; }

    const reader = new FileReader();
    reader.onload = function(e) {
        applicationData.proofBase64 = e.target.result;
        document.getElementById('fileUploadContent').style.display = 'none';
        document.getElementById('filePreview').style.display = 'block';
        document.getElementById('previewImage').src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function changeFile() {
    document.getElementById('paymentProof').value = '';
    document.getElementById('fileUploadContent').style.display = 'block';
    document.getElementById('filePreview').style.display = 'none';
    applicationData.proofBase64 = '';
}

// Summary
function updateApplicationSummary() {
    document.getElementById('summaryName').textContent = applicationData.fullName || '-';
    document.getElementById('summaryEmail').textContent = applicationData.email || '-';
    document.getElementById('summaryPhone').textContent = applicationData.phone || '-';
    document.getElementById('summaryReferral').textContent = sessionStorage.getItem('referrerCode') || 'None';

    const paymentProofStatus = document.getElementById('paymentProofStatus');
    if (applicationData.proofBase64) {
        paymentProofStatus.innerHTML = `<span style="color:#28a745;">✅ Uploaded</span>`;
    } else {
        paymentProofStatus.innerHTML = `<span style="color:#dc3545;">❌ Not uploaded</span>`;
    }
}

// Submit application
function submitApplication() {
    if (!document.getElementById('termsAgreement').checked) { alert('Agree to Terms'); return; }
    if (!applicationData.fullName || !applicationData.email || !applicationData.phone) { alert('Complete all info'); prevStep(1); return; }
    if (!applicationData.proofBase64) { alert('Upload payment proof'); prevStep(2); return; }

    const submitButton = document.getElementById('submitButton');
    submitButton.disabled = true;

    const applicationId = 'CTA-' + Date.now();
    const application = {
        id: applicationId,
        fullName: applicationData.fullName,
        email: applicationData.email,
        phone: applicationData.phone,
        referralCodeUsed: sessionStorage.getItem('referrerCode') || '',
        proofBase64: applicationData.proofBase64,
        status: 'pending',
        submittedAt: new Date().toISOString()
    };

    const applications = JSON.parse(localStorage.getItem('referral_applications') || '[]');
    applications.push(application);
    localStorage.setItem('referral_applications', JSON.stringify(applications));

    const user = {
        id: 'USER-' + Date.now(),
        fullName: applicationData.fullName,
        email: applicationData.email,
        phone: applicationData.phone,
        userReferralCode: 'CTA-' + applicationData.fullName.substring(0,3).toUpperCase() + '-' + Date.now().toString().slice(-4),
        referrals: [],
        pendingEarnings: 0,
        balance: 0,
        applicationId: applicationId
    };

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    users.push(user);
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('current_user_email', applicationData.email);

    setTimeout(() => {
        document.getElementById('successModal').style.display = 'flex';
        let countdown = 3;
        const countdownElement = document.getElementById('redirectCountdown');
        const countdownInterval = setInterval(() => {
            countdown--;
            countdownElement.textContent = countdown;
            if(countdown <= 0){
                clearInterval(countdownInterval);
                window.location.href = 'referral-pending.html';
            }
        },1000);
    }, 500);
}
</script>
