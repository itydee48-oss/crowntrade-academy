<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Referral Dashboard - Crown Trade Academy</title>
<link rel="stylesheet" href="style.css">
<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; }
  .premium-header { background:#3a2d28; padding:1rem; }
  .premium-header .premium-nav { display:flex; justify-content:space-between; align-items:center; }
  .premium-header .premium-nav a.logo { color:#d4af37; font-weight:bold; text-decoration:none; font-size:1.2rem; }
  .premium-card { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:2rem; max-width:800px; margin:3rem auto; }
  h1,h3,h4 { color:#3a2d28; }
  .referral-info, .referrals-list { margin-bottom:2rem; }
  .referral-link { background:#f0f0f0; padding:0.5rem; border-radius:6px; word-break:break-all; display:inline-block; margin-top:0.5rem; color:#3a2d28; font-weight:600; }
  .earnings { background:#d4af37; color:#3a2d28; padding:0.5rem 1rem; border-radius:6px; display:inline-block; margin-top:0.5rem; font-weight:bold; }
  table { width:100%; border-collapse:collapse; }
  th,td { padding:0.8rem; text-align:left; border-bottom:1px solid #ccc; }
  th { background:#f5f5f5; }
  .status-pending { color:#ffc107; font-weight:bold; }
  .status-approved { color:#28a745; font-weight:bold; }
  .btn-premium { background:#d4af37; color:#3a2d28; padding:0.6rem 1.2rem; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-top:1rem; }
</style>
</head>
<body>

<header class="premium-header">
  <nav class="premium-nav">
    <a href="index.html" class="logo">Crown Trade Academy</a>
  </nav>
</header>

<section>
  <div class="premium-card">
    <h1>Your Referral Dashboard</h1>

    <div class="referral-info">
      <h3>Welcome, <span id="userName">-</span></h3>
      <div>Your unique referral link:</div>
      <div class="referral-link" id="userReferralLink">-</div>
      <div class="earnings">Your Current Earnings: KES <span id="userEarnings">0</span></div>
    </div>

    <div class="referrals-list">
      <h3>Referrals Status</h3>
      <table>
        <thead>
          <tr>
            <th>Referral Name</th>
            <th>Email</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="referralsTable">
          <!-- Filled dynamically -->
        </tbody>
      </table>
    </div>

    <button class="btn-premium" onclick="logout()">Logout</button>
  </div>
</section>

<script>
const currentUserEmail = localStorage.getItem('current_user_email');
let applications = JSON.parse(localStorage.getItem('referral_applications')||'[]');

function getCurrentUser(){
  return applications.find(app=>app.email===currentUserEmail);
}

function updateDashboard(){
  const user = getCurrentUser();
  if(!user){ window.location.href='referral-register.html'; return; }
  document.getElementById('userName').textContent=user.fullName;
  const referralLink = `${window.location.origin}/referral-register.html?ref=${user.email}`;
  document.getElementById('userReferralLink').textContent=referralLink;

  // Calculate earnings: only approved referrals
  let earnings = 0;
  const referrals = applications.filter(app=>app.referralCode===user.email);
  referrals.forEach(r=>{ if(r.status==='approved') earnings+=300; });
  document.getElementById('userEarnings').textContent=earnings;

  // Populate referrals table
  const tbody = document.getElementById('referralsTable');
  tbody.innerHTML='';
  referrals.forEach(r=>{
    const tr=document.createElement('tr');
    const nameTd=document.createElement('td'); nameTd.textContent=r.fullName;
    const emailTd=document.createElement('td'); emailTd.textContent=r.email;
    const statusTd=document.createElement('td');
    statusTd.textContent=r.status;
    statusTd.className = r.status==='approved'?'status-approved':'status-pending';
    tr.appendChild(nameTd); tr.appendChild(emailTd); tr.appendChild(statusTd);
    tbody.appendChild(tr);
  });
}

// Check URL params to auto-fill referral code
const urlParams = new URLSearchParams(window.location.search);
const ref = urlParams.get('ref');
if(ref && currentUserEmail===null){ 
  // prefill referral code for new user
  const regData = JSON.parse(localStorage.getItem('referral_register_temp')||'{}');
  regData.referralCode=ref;
  localStorage.setItem('referral_register_temp', JSON.stringify(regData));
}

updateDashboard();

function logout(){
  localStorage.removeItem('current_user_email');
  window.location.href='login.html';
}
</script>

</body>
</html>
