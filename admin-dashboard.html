<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - Crown Trade Academy</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --dark-brown: #3A2D28;
      --muted-rose: #A48374;
      --warm-beige: #CBAD8D;
      --light-taupe: #D1C7BD;
      --off-white: #EBE3DB;
      --cream-white: #F1EDE6;
      --gold-accent: #D4AF37;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--off-white) 0%, var(--cream-white) 100%);
      color: var(--dark-brown);
      line-height:1.6;
      min-height:100vh;
    }
    .premium-header{
      background: linear-gradient(135deg, var(--dark-brown) 0%, #2A1F1A 100%);
      color: var(--cream-white);
      padding:1.2rem 0;
      box-shadow:0 4px 20px rgba(58,45,40,0.1);
      border-bottom:3px solid var(--gold-accent);
    }
    .premium-nav{ display:flex; justify-content:space-between; align-items:center; max-width:1200px; margin:0 auto; padding:0 2rem; }
    .logo{ font-size:2rem; font-weight:700; color:var(--warm-beige); text-decoration:none; }
    .nav-links{ display:flex; gap:2rem; list-style:none; align-items:center; }
    .nav-links a{ color:var(--cream-white); text-decoration:none; font-weight:500; }
    .premium-container{ max-width:1200px; margin:0 auto; padding:0 20px; }
    .premium-card{
      background: linear-gradient(135deg, var(--cream-white) 0%, #FFFFFF 100%);
      border:1px solid var(--light-taupe);
      border-radius:20px;
      padding:2.5rem;
      margin:1.5rem 0;
      position:relative;
      overflow:hidden;
      box-shadow:0 15px 40px rgba(58,45,40,0.08);
    }
    .premium-card::before{ content:''; position:absolute; top:0; left:0; right:0; height:4px;
      background: linear-gradient(90deg, var(--gold-accent), var(--warm-beige), var(--gold-accent)); }
    .btn-premium{
      background: linear-gradient(135deg, var(--dark-brown) 0%, #4A3A32 100%);
      color: var(--cream-white); border:none; padding:1rem 2rem; border-radius:12px; font-weight:700; cursor:pointer;
    }
    .btn-success {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-info {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .premium-footer{ background: linear-gradient(135deg, var(--dark-brown) 0%, #2A1F1A 100%); color: var(--cream-white); padding:3rem 0 2rem; margin-top:4rem; border-top:3px solid var(--gold-accent); }
    .footer-content{ max-width:1200px; margin:0 auto; padding:0 2rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:2rem; }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }
    
    .stat-card {
      background: var(--off-white);
      border: 1px solid var(--light-taupe);
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(139, 115, 85, 0.1);
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--dark-brown);
      margin-bottom: 0.5rem;
    }
    
    .stat-label {
      color: var(--muted-rose);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Application Cards */
    .application-card {
      background: var(--off-white);
      border: 1px solid var(--light-taupe);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .status-pending { background: #ffc107; color: var(--dark-brown); }
    .status-approved { background: #28a745; color: white; }
    .status-rejected { background: #dc3545; color: white; }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--light-taupe);
    }
    
    .tab {
      padding: 1rem 2rem;
      background: none;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      color: var(--muted-rose);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .tab.active {
      color: var(--dark-brown);
      border-bottom-color: var(--gold-accent);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Chart Container */
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin: 2rem 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    /* Settings Form */
    .settings-form {
      background: var(--off-white);
      padding: 2rem;
      border-radius: 12px;
      margin: 1rem 0;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--dark-brown);
    }
    
    .form-control {
      width: 100%;
      padding: 1rem;
      border: 2px solid var(--light-taupe);
      border-radius: 8px;
      background: white;
      color: var(--dark-brown);
      font-size: 1rem;
    }
    
    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 2rem 0;
    }
    
    .action-card {
      background: var(--off-white);
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      border: 2px solid var(--light-taupe);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .action-card:hover {
      border-color: var(--gold-accent);
      transform: translateY(-2px);
    }

    /* NEW STYLES FOR ENHANCEMENTS */
    
    /* Search and Filter */
    .search-filter-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .search-box {
      flex: 1;
      min-width: 250px;
    }
    
    .filter-select {
      padding: 0.75rem;
      border: 2px solid var(--light-taupe);
      border-radius: 8px;
      background: white;
      color: var(--dark-brown);
      font-size: 1rem;
    }
    
    /* Notification System */
    .notification-badge {
      position: relative;
    }
    
    .notification-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--gold-accent);
      color: var(--dark-brown);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .notification-panel {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid var(--light-taupe);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      width: 350px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    
    .notification-panel.active {
      display: block;
    }
    
    .notification-item {
      padding: 1rem;
      border-bottom: 1px solid var(--light-taupe);
    }
    
    .notification-item:last-child {
      border-bottom: none;
    }
    
    .notification-item.unread {
      background: rgba(212, 175, 55, 0.1);
    }
    
    /* User Management */
    .user-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .user-card {
      background: var(--off-white);
      border: 1px solid var(--light-taupe);
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    /* Mobile Menu */
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--cream-white);
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    /* Loading States */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .spinner {
      border: 4px solid var(--light-taupe);
      border-top: 4px solid var(--gold-accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .premium-nav {
        flex-direction: column;
        gap: 1rem;
      }
      
      .nav-links {
        flex-direction: column;
        gap: 1rem;
        width: 100%;
        display: none;
      }
      
      .nav-links.active {
        display: flex;
      }
      
      .mobile-menu-btn {
        display: block;
        position: absolute;
        right: 2rem;
        top: 1.5rem;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .search-filter-bar {
        flex-direction: column;
      }
      
      .quick-actions {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="premium-header">
    <nav class="premium-nav">
      <a href="index.html" class="logo">Crown Trade Academy</a>
      <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
      <div style="display: flex; align-items: center; gap: 2rem;">
        <span style="color: var(--warm-beige); font-weight: 600;">Admin Dashboard</span>
        <ul class="nav-links" id="navLinks">
          <li><a href="admin-dashboard.html" style="color: var(--warm-beige);">Dashboard</a></li>
          <li class="notification-badge">
            <a href="#" onclick="toggleNotifications()">üîî <span class="notification-count" id="notificationCount">0</span></a>
            <div class="notification-panel" id="notificationPanel">
              <div class="notification-item unread">
                <strong>New Application</strong>
                <p>John Doe submitted a new application</p>
                <small>2 minutes ago</small>
              </div>
              <div class="notification-item">
                <strong>Withdrawal Request</strong>
                <p>Jane Smith requested KES 500 withdrawal</p>
                <small>1 hour ago</small>
              </div>
            </div>
          </li>
          <li><a href="#" onclick="logout()">Logout</a></li>
        </ul>
      </div>
    </nav>
  </header>

  <section class="premium-container" style="padding:2rem 0;">
    <!-- Dashboard Overview -->
    <div class="premium-card">
      <h1 style="color:var(--dark-brown); margin-bottom:2rem;">üìä Business Overview</h1>
      
      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalRevenue">KES 0</div>
          <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="pendingApprovals">0</div>
          <div class="stat-label">Pending Approvals</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalUsers">0</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="conversionRate">0%</div>
          <div class="stat-label">Approval Rate</div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <div class="action-card" onclick="showTab('applications')">
          <h3>üë•</h3>
          <p>Manage Applications</p>
        </div>
        <div class="action-card" onclick="showTab('analytics')">
          <h3>üìà</h3>
          <p>View Analytics</p>
        </div>
        <div class="action-card" onclick="showTab('settings')">
          <h3>‚öôÔ∏è</h3>
          <p>Program Settings</p>
        </div>
        <div class="action-card" onclick="exportData()">
          <h3>üì§</h3>
          <p>Export Data</p>
        </div>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('applications')">üìã Applications</button>
      <button class="tab" onclick="showTab('analytics')">üìà Analytics</button>
      <button class="tab" onclick="showTab('users')">üë• Users</button>
      <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
      <button class="tab" onclick="showTab('withdrawals')">üí≥ Withdrawals</button>
    </div>

    <!-- Applications Tab -->
    <div id="applications-tab" class="tab-content active">
      <div class="premium-card">
        <h2 style="color:var(--dark-brown); margin-bottom:1rem;">Pending Applications</h2>
        
        <!-- Search and Filter Bar -->
        <div class="search-filter-bar">
          <div class="search-box">
            <input type="text" id="applicationSearch" class="form-control" placeholder="Search applications..." onkeyup="filterApplications()">
          </div>
          <select id="statusFilter" class="filter-select" onchange="filterApplications()">
            <option value="all">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
          <select id="dateFilter" class="filter-select" onchange="filterApplications()">
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
          </select>
        </div>
        
        <div id="applicationsList">
          <div style="text-align:center; color:var(--muted-rose); padding:3rem;">
            Loading applications...
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics-tab" class="tab-content">
      <div class="premium-card">
        <h2 style="color:var(--dark-brown); margin-bottom:2rem;">Business Analytics</h2>
        
        <div class="chart-container">
          <h3 style="color:var(--dark-brown); margin-bottom:1rem;">Revenue Growth</h3>
          <canvas id="revenueChart"></canvas>
        </div>
        
        <div class="chart-container">
          <h3 style="color:var(--dark-brown); margin-bottom:1rem;">Application Status</h3>
          <canvas id="statusChart"></canvas>
        </div>
        
        <div class="chart-container">
          <h3 style="color:var(--dark-brown); margin-bottom:1rem;">Monthly Performance</h3>
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
      <div class="premium-card">
        <h2 style="color:var(--dark-brown); margin-bottom:1rem;">User Management</h2>
        
        <div class="search-filter-bar">
          <div class="search-box">
            <input type="text" id="userSearch" class="form-control" placeholder="Search users..." onkeyup="filterUsers()">
          </div>
          <select id="userStatusFilter" class="filter-select" onchange="filterUsers()">
            <option value="all">All Users</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        
        <div class="user-grid" id="usersList">
          <div style="text-align:center; color:var(--muted-rose); padding:3rem; grid-column: 1/-1;">
            Loading users...
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="premium-card">
        <h2 style="color:var(--dark-brown); margin-bottom:2rem;">Program Settings</h2>
        
        <div class="settings-form">
          <h3 style="color:var(--dark-brown); margin-bottom:1rem;">üí∞ Payment Settings</h3>
          <div class="form-group">
            <label class="form-label">Registration Fee (KES)</label>
            <input type="number" id="registrationFee" class="form-control" value="500">
          </div>
          <div class="form-group">
            <label class="form-label">Referral Earnings (KES)</label>
            <input type="number" id="referralEarnings" class="form-control" value="300">
          </div>
          <div class="form-group">
            <label class="form-label">Minimum Withdrawal (KES)</label>
            <input type="number" id="minWithdrawal" class="form-control" value="100">
          </div>
          <button class="btn-premium" onclick="savePaymentSettings()">Save Payment Settings</button>
        </div>

        <div class="settings-form">
          <h3 style="color:var(--dark-brown); margin-bottom:1rem;">üìß Email Templates</h3>
          <div class="form-group">
            <label class="form-label">Approval Email Subject</label>
            <input type="text" id="approvalSubject" class="form-control" value="Welcome to Crown Trade Academy!">
          </div>
          <div class="form-group">
            <label class="form-label">Approval Email Message</label>
            <textarea id="approvalMessage" class="form-control" rows="4">Congratulations! Your application has been approved. You can now access your dashboard and start earning.</textarea>
          </div>
          <button class="btn-premium" onclick="saveEmailTemplates()">Save Email Templates</button>
        </div>

        <div class="settings-form">
          <h3 style="color:var(--dark-brown); margin-bottom:1rem;">üîí Admin Settings</h3>
          <div class="form-group">
            <label class="form-label">Change Admin Password</label>
            <input type="password" id="newPassword" class="form-control" placeholder="New password">
          </div>
          <button class="btn-premium" onclick="changeAdminPassword()">Change Password</button>
        </div>
      </div>
    </div>

    <!-- Withdrawals Tab -->
    <div id="withdrawals-tab" class="tab-content">
      <div class="premium-card">
        <h2 style="color:var(--dark-brown); margin-bottom:1rem;">üí≥ Withdrawal Requests</h2>
        <div id="withdrawalsList">
          <div style="text-align:center; color:var(--muted-rose); padding:3rem;">
            No withdrawal requests yet.
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="premium-footer">
    <div class="footer-content">
      <div>
        <h3>Admin Tools</h3>
        <p>Application Management</p>
        <p>Revenue Tracking</p>
      </div>
      <div>
        <h3>Quick Actions</h3>
        <p>Review Applications</p>
        <p>Update Settings</p>
      </div>
      <div>
        <h3>Support</h3>
        <p>Email: crowntradeacademy@gmail.com</p>
        <p>Admin Portal</p>
      </div>
    </div>
    <div style="text-align:center;margin-top:2rem;padding-top:2rem;border-top:1px solid var(--muted-rose);">
      <p>&copy; 2024 Crown Trade Academy. Enhanced Admin Dashboard</p>
    </div>
  </footer>

  <script>
    // Initialize Charts
    let revenueChart, statusChart, monthlyChart;

    // Simple admin authentication
    function checkAdminAuth() {
      const isAdmin = localStorage.getItem('admin_logged_in');
      if (!isAdmin) {
        const password = prompt('Enter admin password:');
        if (password === 'admin123') {
          localStorage.setItem('admin_logged_in', 'true');
        } else {
          alert('Invalid password');
          window.location.href = 'index.html';
        }
      }
    }

    function loadDashboardData() {
      const applications = JSON.parse(localStorage.getItem('referral_applications') || '[]');
      const settings = JSON.parse(localStorage.getItem('program_settings') || '{}');
      
      // Calculate stats
      const pendingApps = applications.filter(app => app.status === 'pending' || !app.status);
      const approvedApps = applications.filter(app => app.status === 'approved');
      const rejectedApps = applications.filter(app => app.status === 'rejected');
      
      const registrationFee = settings.registrationFee || 500;
      const referralEarnings = settings.referralEarnings || 300;
      
      const totalRevenue = approvedApps.length * registrationFee;
      const potentialRevenue = pendingApps.length * registrationFee;
      
      // Update stats
      document.getElementById('totalRevenue').textContent = `KES ${totalRevenue}`;
      document.getElementById('pendingApprovals').textContent = pendingApps.length;
      document.getElementById('totalUsers').textContent = approvedApps.length;
      document.getElementById('conversionRate').textContent = applications.length > 0 
        ? `${Math.round((approvedApps.length / applications.length) * 100)}%` 
        : '0%';
      
      // Update notification count
      document.getElementById('notificationCount').textContent = pendingApps.length;
      
      // Load applications
      loadApplications();
      
      // Load analytics
      loadAnalytics(applications, approvedApps, pendingApps, rejectedApps);
      
      // Load settings
      loadSettings(settings);
      
      // Load withdrawals
      loadWithdrawals();
      
      // Load users
      loadUsers();
    }

    function loadApplications() {
      const applications = JSON.parse(localStorage.getItem('referral_applications') || '[]');
      const pendingApps = applications.filter(app => app.status === 'pending' || !app.status);
      
      const applicationsList = document.getElementById('applicationsList');
      
      if (applications.length === 0) {
        applicationsList.innerHTML = `
          <div style="text-align:center; color:var(--muted-rose); padding:3rem;">
            No applications found.
          </div>
        `;
        return;
      }

      applicationsList.innerHTML = applications.map(app => `
        <div class="application-card" data-status="${app.status || 'pending'}" data-date="${app.submittedAt}">
          <h3 style="color:var(--dark-brown); margin-bottom:0.5rem;">${app.fullName}</h3>
          <p style="color:var(--muted-rose); margin:0.25rem 0;">
            <strong>Email:</strong> ${app.email}
          </p>
          <p style="color:var(--muted-rose); margin:0.25rem 0;">
            <strong>Phone:</strong> ${app.phone}
          </p>
          <p style="color:var(--muted-rose); margin:0.25rem 0;">
            <strong>Applied:</strong> ${new Date(app.submittedAt).toLocaleDateString()}
          </p>
          <p style="margin:0.5rem 0;">
            <span class="status-badge status-${app.status || 'pending'}">${(app.status || 'pending').toUpperCase()}</span>
          </p>
          <p style="margin:0.5rem 0;">
            <a href="#" onclick="viewPaymentProof('${app.id}')" style="color:var(--warm-beige); text-decoration:none;">
              üìé View Payment Proof
            </a>
          </p>
          <div class="action-buttons">
            <button class="btn-success" onclick="approveApplication('${app.id}')" ${app.status === 'approved' ? 'disabled' : ''}>
              Approve
            </button>
            <button class="btn-danger" onclick="rejectApplication('${app.id}')" ${app.status === 'rejected' ? 'disabled' : ''}>
              Reject
            </button>
            <button class="btn-info" onclick="viewApplicationDetails('${app.id}')">
              Details
            </button>
          </div>
        </div>
      `).join('');
    }

    function filterApplications() {
      const searchTerm = document.getElementById('applicationSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;
      
      const applications = document.querySelectorAll('.application-card');
      
      applications.forEach(card => {
        const name = card.querySelector('h3').textContent.toLowerCase();
        const status = card.getAttribute('data-status');
        const date = new Date(card.getAttribute('data-date'));
        const now = new Date();
        
        let show = true;
        
        // Search filter
        if (searchTerm && !name.includes(searchTerm)) {
          show = false;
        }
        
        // Status filter
        if (statusFilter !== 'all' && status !== statusFilter) {
          show = false;
        }
        
        // Date filter
        if (dateFilter !== 'all') {
          const diffTime = Math.abs(now - date);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (dateFilter === 'today' && diffDays > 1) {
            show = false;
          } else if (dateFilter === 'week' && diffDays > 7) {
            show = false;
          } else if (dateFilter === 'month' && diffDays > 30) {
            show = false;
          }
        }
        
        card.style.display = show ? 'block' : 'none';
      });
    }

    function loadUsers() {
      const applications = JSON.parse(localStorage.getItem('referral_applications') || '[]');
      const approvedUsers = applications.filter(app => app.status === 'approved');
      
      const usersList = document.getElementById('usersList');
      
      if (approvedUsers.length === 0) {
        usersList.innerHTML = `
          <div style="text-align:center; color:var(--muted-rose); padding:3rem; grid-column: 1/-1;">
            No approved users yet.
          </div>
        `;
        return;
      }

      usersList.innerHTML = approvedUsers.map(user => `
        <div class="user-card">
          <h3 style="color:var(--dark-brown); margin-bottom:0.5rem;">${user.fullName}</h3>
          <p style="color:var(--muted-rose); margin:0.25rem 0;">
            <strong>Email:</strong> ${user.email}
          </p>
          <p style="color:var(--muted-rose); margin:0.25rem 0;">
            <strong>Phone:</strong> ${user.phone}
          </p>
          <p style="color:var(--muted-rose); margin:0.25rem 0;">
            <strong>Joined:</strong> ${new Date(user.reviewedAt || user.submittedAt).toLocaleDateString()}
          </p>
          <div class="action-buttons">
            <button class="btn-info" onclick="viewUserDetails('${user.id}')">
              View Details
            </button>
            <button class="btn-danger" onclick="deactivateUser('${user.id}')">
              Deactivate
            </button>
          </div>
        </div>
      `).join('');
    }

    function filterUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      const statusFilter = document.getElementById('userStatusFilter').value;
      
      const users = document.querySelectorAll('.user-card');
      
      users.forEach(card => {
        const name = card.querySelector('h3').textContent.toLowerCase();
        
        let show = true;
        
        // Search filter
        if (searchTerm && !name.includes(searchTerm)) {
          show = false;
        }
        
        // Status filter (currently all users are active in this demo)
        if (statusFilter === 'inactive') {
          show = false; // In a real app, you would check the user's status
        }
        
        card.style.display = show ? 'block' : 'none';
      });
    }

    function loadAnalytics(applications, approvedApps, pendingApps, rejectedApps) {
      // Revenue Chart
      const revenueCtx = document.getElementById('revenueChart').getContext('2d');
      if (revenueChart) revenueChart.destroy();
      
      revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [{
            label: 'Revenue (KES)',
            data: [0, 0, 0, 0, 0, approvedApps.length * 500],
            borderColor: '#3A2D28',
            backgroundColor: 'rgba(58, 45, 40, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Monthly Revenue Growth'
            }
          }
        }
      });

      // Status Chart
      const statusCtx = document.getElementById('statusChart').getContext('2d');
      if (statusChart) statusChart.destroy();
      
      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['Approved', 'Pending', 'Rejected'],
          datasets: [{
            data: [approvedApps.length, pendingApps.length, rejectedApps.length],
            backgroundColor: ['#28a745', '#ffc107', '#dc3545']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Monthly Chart
      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      if (monthlyChart) monthlyChart.destroy();
      
      monthlyChart = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: ['Applications', 'Approvals', 'Revenue'],
          datasets: [{
            label: 'This Month',
            data: [applications.length, approvedApps.length, approvedApps.length * 500],
            backgroundColor: '#A48374'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Current Month Performance'
            }
          }
        }
      });
    }

    function loadSettings(settings) {
      document.getElementById('registrationFee').value = settings.registrationFee || 500;
      document.getElementById('referralEarnings').value = settings.referralEarnings || 300;
      document.getElementById('minWithdrawal').value = settings.minWithdrawal || 100;
      document.getElementById('approvalSubject').value = settings.approvalSubject || 'Welcome to Crown Trade Academy!';
      document.getElementById('approvalMessage').value = settings.approvalMessage || 'Congratulations! Your application has been approved.';
    }

    function loadWithdrawals() {
      const withdrawals = JSON.parse(localStorage.getItem('withdrawal_requests') || '[]');
      const withdrawalsList = document.getElementById('withdrawalsList');
      
      if (withdrawals.length === 0) {
        withdrawalsList.innerHTML = `
          <div style="text-align:center; color:var(--muted-rose); padding:3rem;">
            No withdrawal requests yet.
          </div>
        `;
        return;
      }

      withdrawalsList.innerHTML = withdrawals.map((withdrawal, index) => `
        <div class="application-card">
          <h3 style="color:var(--dark-brown); margin-bottom:0.5rem;">${withdrawal.userName}</h3>
          <p style="color:var(--muted-rose); margin:0.25rem 0;">
            <strong>Amount:</strong> KES ${withdrawal.amount}
          </p>
          <p style="color:var(--muted-rose); margin:0.25rem 0;">
            <strong>MPesa:</strong> ${withdrawal.phone}
          </p>
          <p style="color:var(--muted-rose); margin:0.25rem 0;">
            <strong>Requested:</strong> ${new Date(withdrawal.requestedAt).toLocaleDateString()}
          </p>
          <div class="action-buttons">
            <button class="btn-success" onclick="processWithdrawal(${index})">
              Process
            </button>
            <button class="btn-danger" onclick="rejectWithdrawal(${index})">
              Reject
            </button>
          </div>
        </div>
      `).join('');
    }

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(`${tabName}-tab`).classList.add('active');
      event.target.classList.add('active');
    }

    function toggleNotifications() {
      const panel = document.getElementById('notificationPanel');
      panel.classList.toggle('active');
      event.preventDefault();
    }

    function toggleMobileMenu() {
      const navLinks = document.getElementById('navLinks');
      navLinks.classList.toggle('active');
    }

    function approveApplication(appId) {
      if (confirm('Approve this application?')) {
        const applications = JSON.parse(localStorage.getItem('referral_applications') || '[]');
        const appIndex = applications.findIndex(app => app.id === appId);
        
        if (appIndex !== -1) {
          applications[appIndex].status = 'approved';
          applications[appIndex].reviewedAt = new Date().toISOString();
          localStorage.setItem('referral_applications', JSON.stringify(applications));
          alert('Application approved!');
          loadDashboardData();
        }
      }
    }

    function rejectApplication(appId) {
      const reason = prompt('Enter rejection reason:');
      if (reason) {
        const applications = JSON.parse(localStorage.getItem('referral_applications') || '[]');
        const appIndex = applications.findIndex(app => app.id === appId);
        
        if (appIndex !== -1) {
          applications[appIndex].status = 'rejected';
          applications[appIndex].rejectionReason = reason;
          applications[appIndex].reviewedAt = new Date().toISOString();
          localStorage.setItem('referral_applications', JSON.stringify(applications));
          alert('Application rejected.');
          loadDashboardData();
        }
      }
    }

    function viewPaymentProof(appId) {
      const applications = JSON.parse(localStorage.getItem('referral_applications') || '[]');
      const app = applications.find(app => app.id === appId);
      
      if (app && app.proofBase64) {
        const newWindow = window.open();
        newWindow.document.write(`
          <html>
            <head><title>Payment Proof - ${app.fullName}</title></head>
            <body style="margin:0; padding:20px; text-align:center; background:#f5f5f5;">
              <h2>Payment Proof - ${app.fullName}</h2>
              <img src="${app.proofBase64}" style="max-width:100%; max-height:80vh; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.1);" />
              <br><br>
              <button onclick="window.close()" style="padding:10px 20px; background:#3A2D28; color:white; border:none; border-radius:5px; cursor:pointer;">
                Close
              </button>
            </body>
          </html>
        `);
      }
    }

    function viewApplicationDetails(appId) {
      const applications = JSON.parse(localStorage.getItem('referral_applications') || '[]');
      const app = applications.find(app => app.id === appId);
      
      if (app) {
        alert(`Application Details:\n\nName: ${app.fullName}\nEmail: ${app.email}\nPhone: ${app.phone}\nStatus: ${app.status || 'Pending'}\nSubmitted: ${new Date(app.submittedAt).toLocaleString()}`);
      }
    }

    function viewUserDetails(userId) {
      const applications = JSON.parse(localStorage.getItem('referral_applications') || '[]');
      const user = applications.find(app => app.id === userId);
      
      if (user) {
        alert(`User Details:\n\nName: ${user.fullName}\nEmail: ${user.email}\nPhone: ${user.phone}\nStatus: Approved\nJoined: ${new Date(user.reviewedAt || user.submittedAt).toLocaleString()}`);
      }
    }

    function deactivateUser(userId) {
      if (confirm('Deactivate this user? They will no longer have access to the platform.')) {
        // In a real app, you would update the user's status in the database
        alert('User deactivated successfully!');
        loadUsers();
      }
    }

    function savePaymentSettings() {
      const settings = {
        registrationFee: parseInt(document.getElementById('registrationFee').value),
        referralEarnings: parseInt(document.getElementById('referralEarnings').value),
        minWithdrawal: parseInt(document.getElementById('minWithdrawal').value),
        approvalSubject: document.getElementById('approvalSubject').value,
        approvalMessage: document.getElementById('approvalMessage').value
      };
      
      localStorage.setItem('program_settings', JSON.stringify(settings));
      alert('Payment settings saved successfully!');
    }

    function saveEmailTemplates() {
      const settings = JSON.parse(localStorage.getItem('program_settings') || '{}');
      settings.approvalSubject = document.getElementById('approvalSubject').value;
      settings.approvalMessage = document.getElementById('approvalMessage').value;
      
      localStorage.setItem('program_settings', JSON.stringify(settings));
      alert('Email templates saved successfully!');
    }

    function changeAdminPassword() {
      const newPassword = document.getElementById('newPassword').value;
      if (newPassword && newPassword.length >= 6) {
        alert('Admin password changed successfully! New password: ' + newPassword);
        document.getElementById('newPassword').value = '';
      } else {
        alert('Password must be at least 6 characters long.');
      }
    }

    function processWithdrawal(index) {
      if (confirm('Mark this withdrawal as processed?')) {
        const withdrawals = JSON.parse(localStorage.getItem('withdrawal_requests') || '[]');
        withdrawals.splice(index, 1);
        localStorage.setItem('withdrawal_requests', JSON.stringify(withdrawals));
        alert('Withdrawal processed successfully!');
        loadWithdrawals();
      }
    }

    function rejectWithdrawal(index) {
      const reason = prompt('Enter rejection reason:');
      if (reason) {
        const withdrawals = JSON.parse(localStorage.getItem('withdrawal_requests') || '[]');
        withdrawals.splice(index, 1);
        localStorage.setItem('withdrawal_requests', JSON.stringify(withdrawals));
        alert('Withdrawal rejected.');
        loadWithdrawals();
      }
    }

    function exportData() {
      const applications = JSON.parse(localStorage.getItem('referral_applications') || '[]');
      const dataStr = JSON.stringify(applications, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'referral_applications.json';
      link.click();
      URL.revokeObjectURL(url);
    }

    function logout() {
      localStorage.removeItem('admin_logged_in');
      window.location.href = 'index.html';
    }

    // Close notification panel when clicking outside
    document.addEventListener('click', function(event) {
      const notificationPanel = document.getElementById('notificationPanel');
      const notificationBadge = document.querySelector('.notification-badge');
      
      if (!notificationBadge.contains(event.target) && notificationPanel.classList.contains('active')) {
        notificationPanel.classList.remove('active');
      }
    });

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', function() {
      checkAdminAuth();
      loadDashboardData();
      
      // Set up mobile menu
      document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
      
      // Auto-refresh every 30 seconds
      setInterval(loadDashboardData, 30000);
    });
  </script>
</body>
</html>
