<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Crown Trade Academy</title>
<link rel="stylesheet" href="style.css">
<style>
  body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;}
  .premium-header{background:#3a2d28;padding:1rem;}
  .premium-header .premium-nav{display:flex;justify-content:space-between;align-items:center;}
  .premium-header .premium-nav a.logo{color:#d4af37;font-weight:bold;text-decoration:none;font-size:1.2rem;}
  .premium-container{max-width:900px;margin:3rem auto;padding:2rem;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  table{width:100%;border-collapse:collapse;margin-top:1.5rem;}
  th,td{padding:0.8rem;border:1px solid #ccc;text-align:left;}
  th{background:#d4af37;color:#3a2d28;}
  button{padding:0.5rem 1rem;border:none;border-radius:6px;cursor:pointer;}
  .btn-approve{background:#28a745;color:#fff;}
  .btn-reject{background:#dc3545;color:#fff;}
</style>
</head>
<body>

<header class="premium-header">
  <nav class="premium-nav">
    <a href="admin-dashboard.html" class="logo">Crown Trade Academy - Admin</a>
  </nav>
</header>

<section class="premium-container">
  <h1>Referral Applications</h1>
  <table id="applicationsTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Referral Code</th>
        <th>Status</th>
        <th>Payment Proof</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
function loadApplications(){
  const applications = JSON.parse(localStorage.getItem('referral_applications')||'[]');
  const tbody = document.querySelector('#applicationsTable tbody');
  tbody.innerHTML = '';
  applications.forEach((app,index)=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${app.fullName}</td>
      <td>${app.email}</td>
      <td>${app.phone}</td>
      <td>${app.referralCode||'None'}</td>
      <td>${app.status}</td>
      <td>${app.proofBase64?'<button onclick="viewProof('+index+')">View</button>':'Not uploaded'}</td>
      <td>
        ${app.status==='pending'?`
          <button class="btn-approve" onclick="approveApplication(${index})">Approve</button>
          <button class="btn-reject" onclick="rejectApplication(${index})">Reject</button>
        `:'-'}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function viewProof(index){
  const applications = JSON.parse(localStorage.getItem('referral_applications')||'[]');
  const app = applications[index];
  if(app.proofBase64){
    const win = window.open();
    win.document.write(`<img src="${app.proofBase64}" style="max-width:100%; margin-top:20px;">`);
  }
}

function approveApplication(index){
  const applications = JSON.parse(localStorage.getItem('referral_applications')||'[]');
  const app = applications[index];
  app.status='approved';
  applications[index]=app;
  localStorage.setItem('referral_applications',JSON.stringify(applications));

  // Update user status
  const users = JSON.parse(localStorage.getItem('users')||'[]');
  const userIndex = users.findIndex(u=>u.email===app.email);
  if(userIndex!==-1){
    users[userIndex].status='approved';
    users[userIndex].approvedAt = new Date().toISOString();
    
    // Check if user was referred
    if(users[userIndex].referralCodeUsed){
      const referrerIndex = users.findIndex(u=>u.email===users[userIndex].referralCodeUsed);
      if(referrerIndex!==-1){
        users[referrerIndex].balance += 300; // Referrer bonus
        users[userIndex].balance += 0; // New user starts at 0 (already paid to business?)
        alert(`${users[referrerIndex].fullName} received KES 300 as referral bonus!`);
      }
      // Business gets KES 200 (not tracked in user balance)
    }
  }
  localStorage.setItem('users',JSON.stringify(users));
  loadApplications();
}

function rejectApplication(index){
  const applications = JSON.parse(localStorage.getItem('referral_applications')||'[]');
  const app = applications[index];
  app.status='rejected';
  applications[index]=app;
  localStorage.setItem('referral_applications',JSON.stringify(applications));

  // Update user status
  const users = JSON.parse(localStorage.getItem('users')||'[]');
  const userIndex = users.findIndex(u=>u.email===app.email);
  if(userIndex!==-1){
    users[userIndex].status='rejected';
  }
  localStorage.setItem('users',JSON.stringify(users));
  loadApplications();
}

loadApplications();
</script>

</body>
</html>
