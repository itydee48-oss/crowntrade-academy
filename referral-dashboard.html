<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Referral Dashboard - Crown Trade Academy</title>
<link rel="stylesheet" href="style.css">
<style>
  body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;}
  .premium-header{background:#3a2d28;padding:1rem;}
  .premium-header .premium-nav{display:flex;justify-content:space-between;align-items:center;}
  .premium-header .premium-nav a.logo{color:#d4af37;font-weight:bold;text-decoration:none;font-size:1.2rem;}
  .premium-container{max-width:900px;margin:3rem auto;padding:2rem;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  .card{background:#fff;border:1px solid #ccc;padding:1rem;border-radius:8px;margin-bottom:1rem;}
  .btn-withdraw{background:#28a745;color:#fff;padding:0.5rem 1rem;border:none;border-radius:6px;cursor:pointer;}
  input{padding:0.5rem;width:100%;border-radius:6px;border:1px solid #ccc;}
</style>
</head>
<body>

<header class="premium-header">
  <nav class="premium-nav">
    <a href="referral-dashboard.html" class="logo">Crown Trade Academy</a>
  </nav>
</header>

<section class="premium-container">
  <h1>Referral Dashboard</h1>
  
  <div class="card">
    <h3>Your Unique Referral Link</h3>
    <input type="text" id="referralLink" readonly>
    <button onclick="copyLink()" class="btn-withdraw" style="margin-top:0.5rem;">Copy Link</button>
  </div>

  <div class="card">
    <h3>Referral Earnings</h3>
    <p><strong>Balance:</strong> KES <span id="balance">0</span></p>
    <p><strong>Total Earnings:</strong> KES <span id="totalEarnings">0</span></p>
    <p><strong>Pending Earnings:</strong> KES <span id="pendingEarnings">0</span></p>
    <button class="btn-withdraw" onclick="requestWithdrawal()">Request Withdrawal</button>
  </div>

  <div class="card">
    <h3>Referrals</h3>
    <table style="width:100%;border-collapse:collapse;">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Status</th>
          <th>Earnings</th>
        </tr>
      </thead>
      <tbody id="referralsTable"></tbody>
    </table>
  </div>
</section>

<script>
let currentUserEmail = localStorage.getItem('current_user_email');
let users = JSON.parse(localStorage.getItem('users') || '[]');
let currentUser = users.find(u => u.email === currentUserEmail);

if(!currentUser){
  alert('User not found. Redirecting to login.');
  window.location.href='login.html';
}

function updateDashboard(){
  // Unique referral link
  const link = window.location.origin + '/referral-register.html?ref=' + currentUser.email;
  document.getElementById('referralLink').value = link;

  // Earnings
  document.getElementById('balance').textContent = currentUser.balance || 0;
  document.getElementById('totalEarnings').textContent = currentUser.totalEarnings || 0;
  document.getElementById('pendingEarnings').textContent = currentUser.pendingEarnings || 0;

  // Referrals table
  const referrals = users.filter(u => u.referralCodeUsed === currentUser.email);
  const tbody = document.getElementById('referralsTable');
  tbody.innerHTML = '';
  referrals.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.fullName}</td>
      <td>${r.email}</td>
      <td>${r.status}</td>
      <td>${r.status==='approved'? 300 : 0}</td>
    `;
    tbody.appendChild(tr);
  });
}

function copyLink(){
  const linkInput = document.getElementById('referralLink');
  linkInput.select();
  linkInput.setSelectionRange(0, 99999);
  document.execCommand('copy');
  alert('Referral link copied!');
}

function requestWithdrawal(){
  const amount = parseInt(currentUser.balance || 0);
  if(amount <= 0){
    alert('No balance available for withdrawal.');
    return;
  }

  // Save withdrawal request
  let withdrawals = JSON.parse(localStorage.getItem('withdrawals')||'[]');
  withdrawals.push({
    userEmail: currentUser.email,
    amount: amount,
    status: 'pending',
    requestedAt: new Date().toISOString()
  });
  localStorage.setItem('withdrawals', JSON.stringify(withdrawals));

  // Reset user balance
  currentUser.balance = 0;
  users = users.map(u => u.email === currentUser.email ? currentUser : u);
  localStorage.setItem('users', JSON.stringify(users));

  alert('Withdrawal request submitted!');
  updateDashboard();
}

updateDashboard();
</script>

</body>
</html>
