<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral Dashboard - Crown Trade Academy</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Premium Header -->
    <header class="premium-header">
        <nav class="premium-nav">
            <a href="index.html" class="logo">Crown Trade Academy</a>
            <div style="display: flex; align-items: center; gap: 2rem;">
                <span style="color: var(--warm-beige);">Referral Dashboard</span>
                <ul class="nav-links">
                    <li><a href="client-dashboard.html">Main Dashboard</a></li>
                    <li><a href="referral-dashboard.html" style="color: var(--warm-beige);">Referral Program</a></li>
                    <li><a href="#" onclick="logout()">Logout</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Dashboard Hero -->
    <section class="premium-container" style="padding: 2rem 0;">
        <div class="premium-card" style="background: linear-gradient(135deg, var(--muted-rose), var(--warm-beige)); color: var(--dark-brown);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 2rem;">
                <div>
                    <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">üë• Referral Program</h1>
                    <p style="font-size: 1.1rem; font-weight: 600;">Earn KES 300 for every friend you refer!</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; color: var(--dark-brown);">Member Since</div>
                    <div style="font-size: 1rem; font-weight: 700;" id="memberSince">Loading...</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Referral Stats -->
    <section class="premium-container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-number" id="totalEarnings">KES 0</div>
                <div class="stat-label">Total Earnings</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-number" id="totalReferrals">0</div>
                <div class="stat-label">Total Referrals</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-number" id="successfulReferrals">0</div>
                <div class="stat-label">Successful</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-number" id="pendingEarnings">KES 0</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>
    </section>

    <!-- Referral Link & Sharing -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üîó Your Referral Link</h2>
            
            <div style="background: var(--off-white); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="referralLink" readonly 
                           style="flex: 1; padding: 1rem; border: 2px solid var(--light-taupe); border-radius: 8px; background: white; font-size: 1rem;">
                    <button class="btn-premium" onclick="copyReferralLink()" style="padding: 1rem 1.5rem;">
                        üìã Copy Link
                    </button>
                </div>
            </div>

            <h3 style="margin-bottom: 1rem; color: var(--dark-brown);">üì§ Share Your Link</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <button class="btn-secondary" onclick="shareWhatsApp()">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üì±</div>
                    WhatsApp
                </button>
                <button class="btn-secondary" onclick="shareFacebook()">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìò</div>
                    Facebook
                </button>
                <button class="btn-secondary" onclick="shareTwitter()">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üê¶</div>
                    Twitter
                </button>
                <button class="btn-secondary" onclick="shareEmail()">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìß</div>
                    Email
                </button>
            </div>
        </div>
    </section>

    <!-- How It Works -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üéØ How It Works</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">1</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">Share Your Link</h3>
                    <p style="color: var(--muted-rose);">Share your unique referral link with friends</p>
                </div>
                
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">2</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">They Register</h3>
                    <p style="color: var(--muted-rose);">Friends register using your link</p>
                </div>
                
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">3</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">They Pay</h3>
                    <p style="color: var(--muted-rose);">Friends complete KES 500 registration</p>
                </div>
                
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">4</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">You Earn</h3>
                    <p style="color: var(--muted-rose);">Get KES 300 for each successful referral</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Referral History -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üìä Referral History</h2>
            
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Earnings</th>
                        </tr>
                    </thead>
                    <tbody id="referralHistory">
                        <!-- Referral history will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; margin-top: 1.5rem;">
                <button class="btn-secondary" onclick="loadMoreHistory()">
                    üìÑ Load More History
                </button>
            </div>
        </div>
    </section>

    <!-- Withdrawal Section -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üí≥ Withdraw Earnings</h2>
            
            <div style="background: var(--off-white); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; align-items: end;">
                    <div>
                        <div class="form-group">
                            <label class="form-label">Withdrawal Amount (KES)</label>
                            <input type="number" id="withdrawalAmount" class="form-control" 
                                   min="100" max="50000" placeholder="Min: KES 100">
                            <small style="color: var(--muted-rose);">Available: <span id="availableBalance">KES 0</span></small>
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label class="form-label">MPesa Number</label>
                            <input type="tel" id="withdrawalPhone" class="form-control" 
                                   placeholder="2547XXXXXXXX" value="2547">
                        </div>
                    </div>
                </div>
                
                <button class="btn-premium" onclick="requestWithdrawal()" style="width: 100%; margin-top: 1rem;">
                    üí∞ Request Withdrawal
                </button>
            </div>
            
            <div style="text-align: center;">
                <p style="color: var(--muted-rose);">
                    ‚è≥ Withdrawals processed within 24-48 hours<br>
                    üìû Contact support for urgent requests
                </p>
            </div>
        </div>
    </section>

    <!-- Withdrawal History -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üí∏ Withdrawal History</h2>
            
            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Transaction ID</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawalHistory">
                        <!-- Withdrawal history will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Premium Footer -->
    <footer class="premium-footer">
        <div class="footer-content">
            <div>
                <h3>Referral Support</h3>
                <p>Email: crowntradeacademy@gmail.com</p>
                <p>Phone: +254 700 000 000</p>
                <p>WhatsApp: +254 700 000 000</p>
            </div>
            <div>
                <h3>Quick Links</h3>
                <p><a href="client-dashboard.html" style="color: var(--warm-beige); text-decoration: none;">Main Dashboard</a></p>
                <p><a href="#withdraw" style="color: var(--warm-beige); text-decoration: none;">Withdraw Earnings</a></p>
                <p><a href="#history" style="color: var(--warm-beige); text-decoration: none;">Referral History</a></p>
            </div>
            <div>
                <h3>Program Info</h3>
                <p>KES 300 per referral</p>
                <p>Min withdrawal: KES 100</p>
                <p>24/7 processing</p>
            </div>
        </div>
        <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--muted-rose);">
            <p>&copy; 2024 Crown Trade Academy. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Initialize referral dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkReferralAccess();
            loadReferralData();
            generateReferralLink();
            loadWithdrawalHistory();
        });

        // Check if user has referral access
        function checkReferralAccess() {
            const clientPackage = localStorage.getItem('clientPackage');
            const userEmail = localStorage.getItem('clientEmail');
            const referralData = JSON.parse(localStorage.getItem('referralData') || '{}');
            const userReferralData = referralData[userEmail];
            
            if ((clientPackage !== 'referral-only' && clientPackage !== 'combined') && !userReferralData) {
                alert('You need to join the referral program first!');
                window.location.href = 'client-dashboard.html';
                return;
            }
        }

        // Load referral data
        function loadReferralData() {
            const userEmail = localStorage.getItem('clientEmail');
            const referralData = JSON.parse(localStorage.getItem('referralData') || '{}');
            const userData = referralData[userEmail] || {
                totalEarnings: 0,
                totalReferrals: 0,
                successfulReferrals: 0,
                pendingEarnings: 0,
                referralHistory: [],
                joinDate: new Date().toISOString()
            };

            // Update stats
            document.getElementById('totalEarnings').textContent = 'KES ' + userData.totalEarnings.toLocaleString();
            document.getElementById('totalReferrals').textContent = userData.totalReferrals;
            document.getElementById('successfulReferrals').textContent = userData.successfulReferrals;
            document.getElementById('pendingEarnings').textContent = 'KES ' + userData.pendingEarnings.toLocaleString();
            document.getElementById('availableBalance').textContent = 'KES ' + userData.totalEarnings.toLocaleString();

            // Set member since date
            const joinDate = new Date(userData.joinDate).toLocaleDateString();
            document.getElementById('memberSince').textContent = joinDate;

            // Load referral history
            loadReferralHistory(userData.referralHistory);
        }

        // Generate unique referral link
        function generateReferralLink() {
            const userEmail = localStorage.getItem('clientEmail');
            const referralCode = btoa(userEmail).slice(0, 8).toUpperCase();
            const referralLink = `https://crowntrade.com/register?ref=${referralCode}`;
            
            document.getElementById('referralLink').value = referralLink;
            localStorage.setItem('referralCode', referralCode);
        }

        // Copy referral link
        function copyReferralLink() {
            const referralLink = document.getElementById('referralLink');
            referralLink.select();
            document.execCommand('copy');
            
            alert('‚úÖ Referral link copied to clipboard!');
        }

        // Share functions
        function shareWhatsApp() {
            const link = document.getElementById('referralLink').value;
            const message = `Join Crown Trade Academy using my referral link and earn amazing benefits! ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        function shareFacebook() {
            const link = document.getElementById('referralLink').value;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`, '_blank');
        }

        function shareTwitter() {
            const link = document.getElementById('referralLink').value;
            const message = "Join Crown Trade Academy - Amazing trading platform! Use my referral link:";
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}&url=${encodeURIComponent(link)}`, '_blank');
        }

        function shareEmail() {
            const link = document.getElementById('referralLink').value;
            const subject = "Join Crown Trade Academy with my referral";
            const body = `Hey! Check out Crown Trade Academy - an amazing trading platform. Use my referral link to get started: ${link}`;
            window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
        }

        // Load referral history
        function loadReferralHistory(history) {
            const historyTable = document.getElementById('referralHistory');
            historyTable.innerHTML = '';

            if (history.length === 0) {
                historyTable.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: var(--muted-rose); padding: 2rem;">
                            No referrals yet. Share your link to start earning!
                        </td>
                    </tr>
                `;
                return;
            }

            history.forEach(ref => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600; color: var(--dark-brown);">${ref.name}</td>
                    <td style="color: var(--muted-rose);">${ref.date}</td>
                    <td>
                        <span class="status-badge ${ref.status === 'completed' ? 'status-approved' : ref.status === 'pending' ? 'status-pending' : 'status-rejected'}">
                            ${ref.status}
                        </span>
                    </td>
                    <td style="font-weight: 700; color: var(--dark-brown);">${ref.earnings ? 'KES ' + ref.earnings : '-'}</td>
                `;
                historyTable.appendChild(row);
            });
        }

        // Request withdrawal
        function requestWithdrawal() {
            const amount = parseInt(document.getElementById('withdrawalAmount').value);
            const phone = document.getElementById('withdrawalPhone').value;
            const userEmail = localStorage.getItem('clientEmail');
            const referralData = JSON.parse(localStorage.getItem('referralData') || '{}');
            const userData = referralData[userEmail] || { totalEarnings: 0 };

            if (!amount || !phone) {
                alert('Please enter amount and MPesa number.');
                return;
            }

            if (amount < 100) {
                alert('Minimum withdrawal amount is KES 100.');
                return;
            }

            if (amount > userData.totalEarnings) {
                alert('Insufficient balance for withdrawal.');
                return;
            }

            if (confirm(`Request withdrawal of KES ${amount.toLocaleString()} to ${phone}?`)) {
                // Create withdrawal request
                const withdrawal = {
                    id: 'wd_' + Date.now(),
                    userEmail: userEmail,
                    userName: localStorage.getItem('clientName') || 'User',
                    amount: amount,
                    phone: phone,
                    date: new Date().toISOString(),
                    status: 'pending',
                    transactionId: 'TXN' + Date.now()
                };

                // Save to withdrawal requests
                const withdrawals = JSON.parse(localStorage.getItem('withdrawalRequests') || '[]');
                withdrawals.push(withdrawal);
                localStorage.setItem('withdrawalRequests', JSON.stringify(withdrawals));

                // Update user balance
                userData.totalEarnings -= amount;
                referralData[userEmail] = userData;
                localStorage.setItem('referralData', JSON.stringify(referralData));

                alert('‚úÖ Withdrawal request submitted! Processing within 24-48 hours.');
                
                // Reset form and reload data
                document.getElementById('withdrawalAmount').value = '';
                loadReferralData();
                loadWithdrawalHistory();
            }
        }

        // Load withdrawal history
        function loadWithdrawalHistory() {
            const userEmail = localStorage.getItem('clientEmail');
            const withdrawals = JSON.parse(localStorage.getItem('withdrawalRequests') || '[]');
            const userWithdrawals = withdrawals.filter(wd => wd.userEmail === userEmail);
            const historyTable = document.getElementById('withdrawalHistory');

            if (userWithdrawals.length === 0) {
                historyTable.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: var(--muted-rose); padding: 2rem;">
                            No withdrawal history yet.
                        </td>
                    </tr>
                `;
                return;
            }

            let historyHTML = '';
            userWithdrawals.slice(-5).reverse().forEach(wd => {
                const date = new Date(wd.date).toLocaleDateString();
                historyHTML += `
                    <tr>
                        <td style="color: var(--muted-rose);">${date}</td>
                        <td style="font-weight: 700; color: var(--dark-brown);">KES ${wd.amount.toLocaleString()}</td>
                        <td>
                            <span class="status-badge ${wd.status === 'completed' ? 'status-approved' : wd.status === 'pending' ? 'status-pending' : 'status-rejected'}">
                                ${wd.status}
                            </span>
                        </td>
                        <td style="color: var(--muted-rose); font-size: 0.9rem;">${wd.transactionId}</td>
                    </tr>
                `;
            });

            historyTable.innerHTML = historyHTML;
        }

        function loadMoreHistory() {
            alert('Loading more referral history...');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('clientLoggedIn');
                localStorage.removeItem('clientEmail');
                localStorage.removeItem('clientPackage');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
