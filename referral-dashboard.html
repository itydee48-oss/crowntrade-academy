<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral Dashboard - Crown Trade Academy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --dark-brown: #3A2D28;
            --muted-rose: #A48374;
            --warm-beige: #CBAD8D;
            --light-taupe: #D1C7BD;
            --off-white: #EBE3DB;
            --cream-white: #F1EDE6;
            --gold-accent: #D4AF37;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--off-white) 0%, var(--cream-white) 100%);
            color: var(--dark-brown);
            line-height:1.6;
            min-height:100vh;
        }
        .premium-header{
            background: linear-gradient(135deg, var(--dark-brown) 0%, #2A1F1A 100%);
            color: var(--cream-white);
            padding:1.2rem 0;
            box-shadow:0 4px 20px rgba(58,45,40,0.1);
            border-bottom:3px solid var(--gold-accent);
        }
        .premium-nav{ display:flex; justify-content:space-between; align-items:center; max-width:1200px; margin:0 auto; padding:0 2rem; }
        .logo{ font-size:2rem; font-weight:700; color:var(--warm-beige); text-decoration:none; }
        .nav-links{ display:flex; gap:2rem; list-style:none; align-items:center; }
        .nav-links a{ color:var(--cream-white); text-decoration:none; font-weight:500; }
        .premium-container{ max-width:1200px; margin:0 auto; padding:0 20px; }
        .premium-card{
            background: linear-gradient(135deg, var(--cream-white) 0%, #FFFFFF 100%);
            border:1px solid var(--light-taupe);
            border-radius:20px;
            padding:2.5rem;
            margin:1.5rem 0;
            position:relative;
            overflow:hidden;
            box-shadow:0 15px 40px rgba(58,45,40,0.08);
        }
        .premium-card::before{ content:''; position:absolute; top:0; left:0; right:0; height:4px;
            background: linear-gradient(90deg, var(--gold-accent), var(--warm-beige), var(--gold-accent)); }
        .btn-premium{
            background: linear-gradient(135deg, var(--dark-brown) 0%, #4A3A32 100%);
            color: var(--cream-white); border:none; padding:1rem 2rem; border-radius:12px; font-weight:700; cursor:pointer;
        }
        .btn-secondary {
            background: var(--off-white);
            color: var(--dark-brown);
            border: 2px solid var(--light-taupe);
            padding: 1rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: var(--warm-beige);
            border-color: var(--warm-beige);
        }
        .premium-footer{ background: linear-gradient(135deg, var(--dark-brown) 0%, #2A1F1A 100%); color: var(--cream-white); padding:3rem 0 2rem; margin-top:4rem; border-top:3px solid var(--gold-accent); }
        .footer-content{ max-width:1200px; margin:0 auto; padding:0 2rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:2rem; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .stat-card {
            background: var(--off-white);
            border: 1px solid var(--light-taupe);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(139, 115, 85, 0.1);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--muted-rose);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-brown);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--muted-rose);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .referral-link-container {
            background: var(--off-white);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 1px solid var(--light-taupe);
        }
        
        .referral-input {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .activity-list {
            list-style: none;
            padding: 0;
        }
        
        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem;
            border-bottom: 1px solid var(--light-taupe);
            transition: background 0.3s ease;
        }
        
        .activity-item:hover {
            background: var(--off-white);
        }
        
        .withdrawal-form {
            background: var(--off-white);
            padding: 2rem;
            border-radius: 12px;
            margin: 1.5rem 0;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: .5rem;
            font-weight: 600;
            color: var(--dark-brown);
        }
        
        .form-control {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--light-taupe);
            border-radius: 8px;
            background: white;
            color: var(--dark-brown);
            font-size: 1rem;
            font-family: inherit;
        }
        
        .luxury-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .luxury-table th,
        .luxury-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--light-taupe);
        }
        
        .luxury-table th {
            background: var(--off-white);
            color: var(--dark-brown);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Premium Header -->
    <header class="premium-header">
        <nav class="premium-nav">
            <a href="index.html" class="logo">Crown Trade Academy</a>
            <div style="display: flex; align-items: center; gap: 2rem;">
                <span style="color: var(--warm-beige); font-weight: 600;">Referral Dashboard</span>
                <ul class="nav-links">
                    <li><a href="referral-dashboard.html" style="color: var(--warm-beige);">Dashboard</a></li>
                    <li><a href="#" onclick="logout()">Logout</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Dashboard Hero -->
    <section class="premium-container" style="padding: 2rem 0;">
        <div class="premium-card" style="background: linear-gradient(135deg, var(--muted-rose), var(--warm-beige)); color: var(--dark-brown);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 2rem;">
                <div>
                    <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">üë• Welcome to Your Referral Dashboard!</h1>
                    <p style="font-size: 1.1rem; font-weight: 600;" id="welcomeMessage">Start earning through referrals</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; color: var(--dark-brown);">Member Since</div>
                    <div style="font-size: 1rem; font-weight: 700;" id="memberSince">Loading...</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Stats -->
    <section class="premium-container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-number" id="totalEarnings">KES 0</div>
                <div class="stat-label">Total Earnings</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-number" id="totalReferrals">0</div>
                <div class="stat-label">Total Referrals</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-number" id="successfulReferrals">0</div>
                <div class="stat-label">Successful</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-number" id="pendingEarnings">KES 0</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>
    </section>

    <!-- Referral Link & Sharing -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üîó Your Referral Link</h2>
            
            <div class="referral-link-container">
                <p style="color: var(--muted-rose); margin-bottom: 1rem;">
                    Share this link and earn <strong style="color: var(--dark-brown);">KES 300</strong> for every friend who joins!
                </p>
                
                <div class="referral-input">
                    <input type="text" id="referralLink" readonly 
                           style="flex: 1; padding: 1rem; border: 2px solid var(--light-taupe); border-radius: 8px; background: white; font-size: 1rem;">
                    <button class="btn-premium" onclick="copyReferralLink()" style="padding: 1rem 1.5rem;">
                        üìã Copy Link
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn-secondary" onclick="shareWhatsApp()">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üì±</div>
                        WhatsApp
                    </button>
                    <button class="btn-secondary" onclick="shareFacebook()">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìò</div>
                        Facebook
                    </button>
                    <button class="btn-secondary" onclick="shareTwitter()">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üê¶</div>
                        Twitter
                    </button>
                    <button class="btn-secondary" onclick="shareEmail()">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìß</div>
                        Email
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- How It Works -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üéØ How It Works</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">1</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">Share Your Link</h3>
                    <p style="color: var(--muted-rose);">Share your unique referral link with friends</p>
                </div>
                
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">2</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">They Register</h3>
                    <p style="color: var(--muted-rose);">Friends register using your link</p>
                </div>
                
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">3</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">They Pay</h3>
                    <p style="color: var(--muted-rose);">Friends complete KES 500 registration</p>
                </div>
                
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">4</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">You Earn</h3>
                    <p style="color: var(--muted-rose);">Get KES 300 for each successful referral</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Withdrawal Section -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üí≥ Withdraw Your Earnings</h2>
            
            <div class="withdrawal-form">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; align-items: end;">
                    <div>
                        <div class="form-group">
                            <label class="form-label">Withdrawal Amount (KES)</label>
                            <input type="number" id="withdrawalAmount" class="form-control" 
                                   min="100" max="50000" placeholder="Min: KES 100">
                            <small style="color: var(--muted-rose);">Available: <span id="availableBalance">KES 0</span></small>
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label class="form-label">MPesa Number</label>
                            <input type="tel" id="withdrawalPhone" class="form-control" 
                                   placeholder="2547XXXXXXXX" value="2547" required>
                        </div>
                    </div>
                </div>
                
                <button class="btn-premium" onclick="requestWithdrawal()" style="width: 100%; margin-top: 1rem;">
                    üí∞ Request Withdrawal
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 1rem;">
                <p style="color: var(--muted-rose); font-size: 0.9rem;">
                    ‚è≥ Withdrawals processed within 24-48 hours<br>
                    üìû Contact support for urgent requests
                </p>
            </div>
        </div>
    </section>

    <!-- Referral History -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üìä Your Referral History</h2>
            
            <div style="overflow-x: auto;">
                <table class="luxury-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Earnings</th>
                        </tr>
                    </thead>
                    <tbody id="referralHistory">
                        <tr>
                            <td colspan="4" style="text-align: center; color: var(--muted-rose); padding: 3rem;">
                                No referrals yet. Share your link to start earning!
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Premium Footer -->
    <footer class="premium-footer">
        <div class="footer-content">
            <div>
                <h3>Referral Support</h3>
                <p>Email: crowntradeacademy@gmail.com</p>
                <p>Phone: +254 700 000 000</p>
            </div>
            <div>
                <h3>Quick Links</h3>
                <p><a href="#withdraw" style="color: var(--warm-beige); text-decoration: none;">Withdraw Earnings</a></p>
                <p><a href="#history" style="color: var(--warm-beige); text-decoration: none;">Referral History</a></p>
            </div>
            <div>
                <h3>Program Info</h3>
                <p>KES 300 per referral</p>
                <p>Min withdrawal: KES 100</p>
            </div>
        </div>
        <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--muted-rose);">
            <p>&copy; 2024 Crown Trade Academy. All rights reserved.</p>
        </div>
    </footer>

    <!-- === Firebase Dashboard Integration === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAa16xt5nZTIVNp_NRSZm388XT4hIVoF9k",
            authDomain: "crowntradeacademy-67be1.firebaseapp.com",
            projectId: "crowntradeacademy-67be1",
            storageBucket: "crowntradeacademy-67be1.firebasestorage.app",
            messagingSenderId: "943453710285",
            appId: "1:943453710285:web:7f122e722f03f3854d4684",
            measurementId: "G-7XESVW5YWL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check if user is approved and logged in
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Not logged in, redirect to registration
                window.location.href = 'referral-register.html';
                return;
            }

            // Check if user application is approved
            const applicationQuery = query(
                collection(db, 'referralApplications'),
                where('uid', '==', user.uid),
                where('status', '==', 'approved')
            );
            
            const applicationSnapshot = await getDocs(applicationQuery);
            if (applicationSnapshot.empty) {
                // Not approved, redirect to pending page
                window.location.href = 'referral-pending.html';
                return;
            }

            // User is approved, load dashboard data
            const applicationData = applicationSnapshot.docs[0].data();
            loadDashboardData(user, applicationData);
            setupRealTimeUpdates(user.uid);
        });

        async function loadDashboardData(user, applicationData) {
            // Set user information
            document.getElementById('welcomeMessage').textContent = `Hello ${applicationData.fullName}, start earning today!`;
            document.getElementById('memberSince').textContent = new Date().toLocaleDateString();
            
            // Generate referral link
            const referralLink = `${window.location.origin}/referral-register.html?ref=${user.uid}`;
            document.getElementById('referralLink').value = referralLink;

            // Load user stats
            await loadUserStats(user.uid);
        }

        async function loadUserStats(uid) {
            // Load referral stats from Firestore
            const referralsQuery = query(
                collection(db, 'referrals'),
                where('referrerId', '==', uid)
            );
            
            const referralsSnapshot = await getDocs(referralsQuery);
            const referrals = referralsSnapshot.docs.map(doc => doc.data());
            
            const totalReferrals = referrals.length;
            const successfulReferrals = referrals.filter(ref => ref.status === 'completed').length;
            const totalEarnings = successfulReferrals * 300;
            const pendingReferrals = referrals.filter(ref => ref.status === 'pending').length;

            // Update dashboard stats
            document.getElementById('totalEarnings').textContent = `KES ${totalEarnings}`;
            document.getElementById('totalReferrals').textContent = totalReferrals;
            document.getElementById('successfulReferrals').textContent = successfulReferrals;
            document.getElementById('pendingEarnings').textContent = `KES ${pendingReferrals * 300}`;
            document.getElementById('availableBalance').textContent = `KES ${totalEarnings}`;

            // Load referral history
            loadReferralHistory(referrals);
        }

        function loadReferralHistory(referrals) {
            const historyTable = document.getElementById('referralHistory');
            
            if (referrals.length === 0) {
                historyTable.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: var(--muted-rose); padding: 3rem;">
                            No referrals yet. Share your link to start earning!
                        </td>
                    </tr>
                `;
                return;
            }

            historyTable.innerHTML = referrals.map(referral => `
                <tr>
                    <td>${referral.referredName || 'New Referral'}</td>
                    <td>${new Date(referral.createdAt?.toDate()).toLocaleDateString()}</td>
                    <td>
                        <span style="
                            padding: 0.3rem 0.8rem;
                            border-radius: 20px;
                            font-size: 0.8rem;
                            font-weight: 600;
                            background: ${referral.status === 'completed' ? '#28a745' : 
                                        referral.status === 'pending' ? '#ffc107' : '#dc3545'};
                            color: ${referral.status === 'pending' ? 'var(--dark-brown)' : 'white'};
                        ">
                            ${referral.status}
                        </span>
                    </td>
                    <td>${referral.status === 'completed' ? 'KES 300' : 'KES 0'}</td>
                </tr>
            `).join('');
        }

        function setupRealTimeUpdates(uid) {
            // Real-time listener for new referrals
            const referralsQuery = query(
                collection(db, 'referrals'),
                where('referrerId', '==', uid)
            );

            onSnapshot(referralsQuery, (snapshot) => {
                const referrals = snapshot.docs.map(doc => doc.data());
                loadUserStats(uid); // Refresh stats
            });
        }

        // Logout function
        window.logout = async function() {
            await signOut(auth);
            window.location.href = 'index.html';
        };

        // Copy referral link function
        window.copyReferralLink = function() {
            const referralLink = document.getElementById('referralLink');
            referralLink.select();
            document.execCommand('copy');
            alert('‚úÖ Referral link copied to clipboard!');
        };

        // Share functions
        window.shareWhatsApp = function() {
            const link = document.getElementById('referralLink').value;
            const message = `Join Crown Trade Academy using my referral link and earn amazing benefits! ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        };

        window.shareFacebook = function() {
            const link = document.getElementById('referralLink').value;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`, '_blank');
        };

        window.shareTwitter = function() {
            const link = document.getElementById('referralLink').value;
            const message = "Join Crown Trade Academy - Amazing platform! Use my referral:";
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}&url=${encodeURIComponent(link)}`, '_blank');
        };

        window.shareEmail = function() {
            const link = document.getElementById('referralLink').value;
            const subject = "Join Crown Trade Academy with my referral";
            const body = `Hey! Check out Crown Trade Academy. Use my referral link: ${link}`;
            window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
        };

        // Withdrawal function
        window.requestWithdrawal = async function() {
            const amount = parseInt(document.getElementById('withdrawalAmount').value);
            const phone = document.getElementById('withdrawalPhone').value;
            const user = auth.currentUser;

            if (!amount || !phone) {
                alert('Please enter amount and MPesa number.');
                return;
            }

            if (amount < 100) {
                alert('Minimum withdrawal amount is KES 100.');
                return;
            }

            // Get current balance
            const referralsQuery = query(
                collection(db, 'referrals'),
                where('referrerId', '==', user.uid),
                where('status', '==', 'completed')
            );
            
            const referralsSnapshot = await getDocs(referralsQuery);
            const totalEarnings = referralsSnapshot.size * 300;

            if (amount > totalEarnings) {
                alert('Insufficient balance for withdrawal.');
                return;
            }

            if (confirm(`Request withdrawal of KES ${amount} to ${phone}?`)) {
                // Create withdrawal request in Firestore
                const withdrawalData = {
                    userId: user.uid,
                    userEmail: user.email,
                    amount: amount,
                    phone: phone,
                    status: 'pending',
                    requestedAt: new Date(),
                    processedAt: null
                };

                try {
                    // Add to Firestore
                    await addDoc(collection(db, 'withdrawalRequests'), withdrawalData);
                    alert('‚úÖ Withdrawal request submitted! We will process within 24-48 hours.');
                    
                    // Clear form
                    document.getElementById('withdrawalAmount').value = '';
                    document.getElementById('withdrawalPhone').value = '2547';
                    
                    // Refresh dashboard
                    loadUserStats(user.uid);
                } catch (error) {
                    alert('Error submitting withdrawal request: ' + error.message);
                }
            }
        };
    </script>
</body>
</html>
