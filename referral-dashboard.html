<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral Dashboard - Crown Trade Academy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .stat-card {
            background: var(--off-white);
            border: 1px solid var(--light-taupe);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(139, 115, 85, 0.1);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--nude-medium);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-brown);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--muted-rose);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .referral-link-container {
            background: var(--off-white);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 1px solid var(--light-taupe);
        }
        
        .referral-input {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .activity-list {
            list-style: none;
            padding: 0;
        }
        
        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.2rem;
            border-bottom: 1px solid var(--light-taupe);
            transition: background 0.3s ease;
        }
        
        .activity-item:hover {
            background: var(--off-white);
        }
        
        .withdrawal-form {
            background: var(--off-white);
            padding: 2rem;
            border-radius: 12px;
            margin: 1.5rem 0;
        }
    </style>
</head>
<body>
    <!-- Premium Header -->
    <header class="premium-header">
        <nav class="premium-nav">
            <a href="index.html" class="logo">Crown Trade Academy</a>
            <div style="display: flex; align-items: center; gap: 2rem;">
                <span style="color: var(--warm-beige); font-weight: 600;">Referral Dashboard</span>
                <ul class="nav-links">
                    <li><a href="referral-dashboard.html" style="color: var(--warm-beige);">Dashboard</a></li>
                    <li><a href="#" onclick="logout()">Logout</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Dashboard Hero -->
    <section class="premium-container" style="padding: 2rem 0;">
        <div class="premium-card" style="background: linear-gradient(135deg, var(--muted-rose), var(--warm-beige)); color: var(--dark-brown);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 2rem;">
                <div>
                    <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">üë• Welcome to Your Referral Dashboard!</h1>
                    <p style="font-size: 1.1rem; font-weight: 600;" id="welcomeMessage">Start earning through referrals</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; color: var(--dark-brown);">Member Since</div>
                    <div style="font-size: 1rem; font-weight: 700;" id="memberSince">Loading...</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Quick Stats -->
    <section class="premium-container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-number" id="totalEarnings">KES 0</div>
                <div class="stat-label">Total Earnings</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-number" id="totalReferrals">0</div>
                <div class="stat-label">Total Referrals</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-number" id="successfulReferrals">0</div>
                <div class="stat-label">Successful</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-number" id="pendingEarnings">KES 0</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>
    </section>

    <!-- Referral Link & Sharing -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üîó Your Referral Link</h2>
            
            <div class="referral-link-container">
                <p style="color: var(--muted-rose); margin-bottom: 1rem;">
                    Share this link and earn <strong style="color: var(--dark-brown);">KES 300</strong> for every friend who joins!
                </p>
                
                <div class="referral-input">
                    <input type="text" id="referralLink" readonly 
                           style="flex: 1; padding: 1rem; border: 2px solid var(--light-taupe); border-radius: 8px; background: white; font-size: 1rem;">
                    <button class="btn-premium" onclick="copyReferralLink()" style="padding: 1rem 1.5rem;">
                        üìã Copy Link
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <button class="btn-secondary" onclick="shareWhatsApp()">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üì±</div>
                        WhatsApp
                    </button>
                    <button class="btn-secondary" onclick="shareFacebook()">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìò</div>
                        Facebook
                    </button>
                    <button class="btn-secondary" onclick="shareTwitter()">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üê¶</div>
                        Twitter
                    </button>
                    <button class="btn-secondary" onclick="shareEmail()">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìß</div>
                        Email
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- How It Works -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üéØ How It Works</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">1</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">Share Your Link</h3>
                    <p style="color: var(--muted-rose);">Share your unique referral link with friends</p>
                </div>
                
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">2</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">They Register</h3>
                    <p style="color: var(--muted-rose);">Friends register using your link</p>
                </div>
                
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">3</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">They Pay</h3>
                    <p style="color: var(--muted-rose);">Friends complete KES 500 registration</p>
                </div>
                
                <div style="text-align: center; padding: 1.5rem; background: var(--off-white); border-radius: 12px;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">4</div>
                    <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">You Earn</h3>
                    <p style="color: var(--muted-rose);">Get KES 300 for each successful referral</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Withdrawal Section -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üí≥ Withdraw Your Earnings</h2>
            
            <div class="withdrawal-form">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; align-items: end;">
                    <div>
                        <div class="form-group">
                            <label class="form-label">Withdrawal Amount (KES)</label>
                            <input type="number" id="withdrawalAmount" class="form-control" 
                                   min="100" max="50000" placeholder="Min: KES 100">
                            <small style="color: var(--muted-rose);">Available: <span id="availableBalance">KES 0</span></small>
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label class="form-label">MPesa Number</label>
                            <input type="tel" id="withdrawalPhone" class="form-control" 
                                   placeholder="2547XXXXXXXX" value="2547" required>
                        </div>
                    </div>
                </div>
                
                <button class="btn-premium" onclick="requestWithdrawal()" style="width: 100%; margin-top: 1rem;">
                    üí∞ Request Withdrawal
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 1rem;">
                <p style="color: var(--muted-rose); font-size: 0.9rem;">
                    ‚è≥ Withdrawals processed within 24-48 hours<br>
                    üìû Contact support for urgent requests
                </p>
            </div>
        </div>
    </section>

    <!-- Referral History -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üìä Your Referral History</h2>
            
            <div style="overflow-x: auto;">
                <table class="luxury-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Earnings</th>
                        </tr>
                    </thead>
                    <tbody id="referralHistory">
                        <tr>
                            <td colspan="4" style="text-align: center; color: var(--muted-rose); padding: 3rem;">
                                No referrals yet. Share your link to start earning!
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Premium Footer -->
    <footer class="premium-footer">
        <div class="footer-content">
            <div>
                <h3>Referral Support</h3>
                <p>Email: crowntradeacademy@gmail.com</p>
                <p>Phone: +254 700 000 000</p>
            </div>
            <div>
                <h3>Quick Links</h3>
                <p><a href="#withdraw" style="color: var(--warm-beige); text-decoration: none;">Withdraw Earnings</a></p>
                <p><a href="#history" style="color: var(--warm-beige); text-decoration: none;">Referral History</a></p>
            </div>
            <div>
                <h3>Program Info</h3>
                <p>KES 300 per referral</p>
                <p>Min withdrawal: KES 100</p>
            </div>
        </div>
        <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--muted-rose);">
            <p>&copy; 2024 Crown Trade Academy. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Check if user is approved referral client
        document.addEventListener('DOMContentLoaded', function() {
            const clientEmail = localStorage.getItem('clientEmail');
            const clientPackage = localStorage.getItem('clientPackage');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const currentUser = users.find(u => u.email === clientEmail);
            
            if (!currentUser || (currentUser.package !== 'referral-only' && currentUser.package !== 'combined')) {
                alert('Access denied. Please join our referral program first.');
                window.location.href = 'referral-register.html';
                return;
            }

            // Initialize dashboard
            loadDashboardData();
            generateReferralLink();
        });

        function loadDashboardData() {
            const clientEmail = localStorage.getItem('clientEmail');
            const referralData = JSON.parse(localStorage.getItem('referralData') || '{}');
            const userData = referralData[clientEmail] || {
                totalEarnings: 0,
                totalReferrals: 0,
                successfulReferrals: 0,
                pendingEarnings: 0,
                referralHistory: [],
                joinDate: new Date().toISOString()
            };

            // Update stats
            document.getElementById('totalEarnings').textContent = 'KES ' + userData.totalEarnings;
            document.getElementById('totalReferrals').textContent = userData.totalReferrals;
            document.getElementById('successfulReferrals').textContent = userData.successfulReferrals;
            document.getElementById('pendingEarnings').textContent = 'KES ' + userData.pendingEarnings;
            document.getElementById('availableBalance').textContent = 'KES ' + userData.totalEarnings;

            // Set member since
            const joinDate = new Date(userData.joinDate).toLocaleDateString();
            document.getElementById('memberSince').textContent = joinDate;

            // Set welcome message
            document.getElementById('welcomeMessage').textContent = `Hello ${localStorage.getItem('clientName') || 'there'}, start earning today!`;

            // Load referral history
            loadReferralHistory(userData.referralHistory);
        }

        function generateReferralLink() {
            const clientEmail = localStorage.getItem('clientEmail');
            const referralCode = btoa(clientEmail).slice(0, 8).toUpperCase();
            const referralLink = `https://crowntrade.com/referral-register.html?ref=${referralCode}`;
            
            document.getElementById('referralLink').value = referralLink;
            localStorage.setItem('userReferralCode', referralCode);
        }

        function copyReferralLink() {
            const referralLink = document.getElementById('referralLink');
            referralLink.select();
            document.execCommand('copy');
            alert('‚úÖ Referral link copied to clipboard!');
        }

        // Share functions
        function shareWhatsApp() {
            const link = document.getElementById('referralLink').value;
            const message = `Join Crown Trade Academy using my referral link and earn amazing benefits! ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        function shareFacebook() {
            const link = document.getElementById('referralLink').value;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}`, '_blank');
        }

        function shareTwitter() {
            const link = document.getElementById('referralLink').value;
            const message = "Join Crown Trade Academy - Amazing platform! Use my referral:";
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}&url=${encodeURIComponent(link)}`, '_blank');
        }

        function shareEmail() {
            const link = document.getElementById('referralLink').value;
            const subject = "Join Crown Trade Academy with my referral";
            const body = `Hey! Check out Crown Trade Academy. Use my referral link: ${link}`;
            window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
        }

        function requestWithdrawal() {
            const amount = parseInt(document.getElementById('withdrawalAmount').value);
            const phone = document.getElementById('withdrawalPhone').value;
            const clientEmail = localStorage.getItem('clientEmail');
            const referralData = JSON.parse(localStorage.getItem('referralData') || '{}');
            const userData = referralData[clientEmail] || { totalEarnings: 0 };

            if (!amount || !phone) {
                alert('Please enter amount and MPesa number.');
                return;
            }

            if (amount < 100) {
                alert('Minimum withdrawal amount is KES 100.');
                return;
            }

            if (amount > userData.totalEarnings) {
                alert('Insufficient balance for withdrawal.');
                return;
            }

            if (confirm(`Request withdrawal of KES ${amount} to ${phone}?`)) {
                // Create withdrawal request
                const withdrawal = {
                    id: 'WD' + Date.now(),
                    userEmail: clientEmail,
                    userName: localStorage.getItem('clientName') || 'User',
                    amount: amount,
                    phone: phone,
                    date: new Date().toISOString(),
                    status: 'pending'
                };

                // Save to withdrawal requests
                let withdrawalRequests = JSON.parse(localStorage.getItem('withdrawalRequests') || '[]');
                withdrawalRequests.push(withdrawal);
                localStorage.setItem('withdrawalRequests', JSON.stringify(withdrawalRequests));

                // Update user balance
                userData.totalEarnings -= amount;
                referralData[clientEmail] = userData;
                localStorage.setItem('referralData', JSON.stringify(referralData));

                alert('‚úÖ Withdrawal request submitted! We will process within 24-48 hours.');
                loadDashboardData(); // Refresh data
            }
        }

        function loadReferralHistory(history) {
            const historyTable = document.getElementById('referralHistory');
            
            if (hist
