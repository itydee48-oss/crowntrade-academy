<script>
// Admin authentication check
if (localStorage.getItem('adminLoggedIn') !== 'true') {
    window.location.href = 'admin-login.html';
}

// Display current user info
document.addEventListener('DOMContentLoaded', function() {
    const adminName = localStorage.getItem('adminName');
    
    // Update page title with user info
    if (adminName) {
        document.title = `${adminName} - Payment Settings - Crown Trade Academy`;
    }
    
    // Load saved settings
    loadPaymentSettings();
});
</script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Settings - Crown Trade Academy</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Premium Header -->
    <header class="premium-header">
        <nav class="premium-nav">
            <a href="index.html" class="logo">Crown Trade Academy</a>
            <div style="display: flex; align-items: center; gap: 2rem;">
                <span style="color: var(--warm-beige);">Payment Settings</span>
                <ul class="nav-links">
                    <li><a href="admin-dashboard.html">Admin Dashboard</a></li>
                    <li><a href="admin-payment-settings.html" style="color: var(--warm-beige);">Payment Settings</a></li>
                    <li><a href="#" onclick="logoutAdmin()">Logout</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Settings Hero -->
    <section class="premium-container" style="padding: 2rem 0;">
        <div class="premium-card" style="background: linear-gradient(135deg, var(--muted-rose), var(--warm-beige)); color: var(--dark-brown);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 2rem;">
                <div>
                    <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">üí∞ Payment Settings</h1>
                    <p style="font-size: 1.1rem; font-weight: 600;">Update bank details, pricing, and flexible payment methods</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; color: var(--dark-brown);">Active Payment Method</div>
                    <div style="font-size: 1rem; font-weight: 700;" id="currentMethodDisplay">MPesa to Phone</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Payment Settings Form -->
    <section class="premium-container">
        <form id="paymentSettingsForm">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Left Column - Bank & Payment Methods -->
                <div>
                    <!-- Bank Details -->
                    <div class="premium-card">
                        <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üè¶ Bank Transfer Details</h2>
                        
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" class="form-control" id="bankName" 
                                   value="Standard Chartered Bank Kenya" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Account Name</label>
                            <input type="text" class="form-control" id="accountName" 
                                   value="Crown Trade Academy" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-control" id="accountNumber" 
                                   value="0100000000000" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Branch</label>
                            <input type="text" class="form-control" id="branch" 
                                   value="Westlands Branch" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">SWIFT Code</label>
                            <input type="text" class="form-control" id="swiftCode" 
                                   value="SCBLKENX" required>
                        </div>
                    </div>

                    <!-- Flexible Payment Methods -->
                    <div class="premium-card">
                        <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üéØ Flexible Payment Methods</h2>
                        
                        <div class="form-group">
                            <label class="form-label">üîÑ Active Payment Method</label>
                            <select class="form-control" id="activePaymentMethod" onchange="updatePaymentPreview()">
                                <option value="phone">üì± MPesa to Phone Number</option>
                                <option value="till">üè™ Till Number</option>
                                <option value="paybill">üè¶ PayBill Number</option>
                            </select>
                            <small style="color: var(--muted-rose);">This method will be shown to clients during registration</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">üì± MPesa Phone Number</label>
                            <input type="tel" class="form-control" id="mpesaNumber" 
                                   value="+254712345678" required oninput="updatePaymentPreview()">
                            <small style="color: var(--muted-rose);">Direct MPesa send to this number</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">üè™ Till Number</label>
                            <input type="text" class="form-control" id="tillNumber" 
                                   value="123456" required oninput="updatePaymentPreview()">
                            <small style="color: var(--muted-rose);">Lipa Na MPesa ‚Üí Buy Goods & Services</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">üè¶ PayBill Number</label>
                            <input type="text" class="form-control" id="paybillNumber" 
                                   value="123456" required oninput="updatePaymentPreview()">
                            <small style="color: var(--muted-rose);">Business number for PayBill payments</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">üî¢ Account Number Format</label>
                            <input type="text" class="form-control" id="accountFormat" 
                                   value="CTA{USER_ID}" required oninput="updatePaymentPreview()">
                            <small style="color: var(--muted-rose);">Use {USER_ID} for dynamic account numbers, {TIMESTAMP} for time-based, {RANDOM} for random codes</small>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Pricing & Instructions -->
                <div>
                    <!-- Program Pricing -->
                    <div class="premium-card">
                        <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üéØ Program Pricing (KES)</h2>
                        
                        <div class="form-group">
                            <label class="form-label">Registration Fee</label>
                            <input type="number" class="form-control" id="registrationFee" 
                                   value="500" min="0" required>
                            <small style="color: var(--muted-rose);">One-time registration fee for referral program</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mentorship Program</label>
                            <input type="number" class="form-control" id="mentorshipFee" 
                                   value="50000" min="0" required>
                            <small style="color: var(--muted-rose);">Elite 1-on-1 training program</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Advanced Program</label>
                            <input type="number" class="form-control" id="advancedFee" 
                                   value="75000" min="0" required>
                            <small style="color: var(--muted-rose);">Advanced trading program (optional)</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Premium Package</label>
                            <input type="number" class="form-control" id="premiumFee" 
                                   value="120000" min="0" required>
                            <small style="color: var(--muted-rose);">Complete premium package (optional)</small>
                        </div>
                    </div>

                    <!-- Referral System -->
                    <div class="premium-card">
                        <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üë• Referral System</h2>
                        
                        <div class="form-group">
                            <label class="form-label">Referral Bonus (KES)</label>
                            <input type="number" class="form-control" id="referralBonus" 
                                   value="300" min="0" required>
                            <small style="color: var(--muted-rose);">Amount earned per successful referral</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Minimum Withdrawal (KES)</label>
                            <input type="number" class="form-control" id="minWithdrawal" 
                                   value="100" min="0" required>
                            <small style="color: var(--muted-rose);">Minimum amount for withdrawal requests</small>
                        </div>
                    </div>

                    <!-- Payment Instructions & Preview -->
                    <div class="premium-card">
                        <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üëÄ Client Payment Preview</h2>
                        
                        <div id="paymentPreview" style="padding: 1.5rem; background: var(--off-white); border-radius: 8px; border-left: 4px solid var(--warm-beige); min-height: 200px;">
                            <div id="previewContent" style="color: var(--muted-rose);">
                                Payment preview will appear here...
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label class="form-label">Contact Email</label>
                            <input type="email" class="form-control" id="contactEmail" 
                                   value="crowntradeacademy@gmail.com" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Verification Message</label>
                            <textarea class="form-control" id="verificationMessage" 
                                      rows="4" required>Kindly before payment contact us through our email crowntradeacademy@gmail.com for verification and payment instructions. All transactions require verification for security purposes.</textarea>
                            <small style="color: var(--muted-rose);">This message appears on all payment pages</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="premium-card" style="margin-top: 2rem;">
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button type="submit" class="btn-premium" style="padding: 1rem 2rem;">
                        üíæ Save All Changes
                    </button>
                    <button type="button" class="btn-secondary" onclick="resetToDefault()" style="padding: 1rem 2rem;">
                        üîÑ Reset to Default
                    </button>
                    <button type="button" class="btn-premium" onclick="testPaymentSystem()" style="padding: 1rem 2rem;">
                        üß™ Test Payment System
                    </button>
                </div>
            </div>
        </form>
    </section>

    <!-- Change History -->
    <section class="premium-container">
        <div class="premium-card">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark-brown);">üìã Change History</h2>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--off-white); border-radius: 8px;">
                    <div>
                        <div style="font-weight: 600; color: var(--dark-brown);">Registration fee updated</div>
                        <div style="color: var(--muted-rose); font-size: 0.9rem;">KES 300 ‚Üí KES 500 ‚Ä¢ Admin User ‚Ä¢ Jan 20, 2024</div>
                    </div>
                    <span class="status-completed">Completed</span>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--off-white); border-radius: 8px;">
                    <div>
                        <div style="font-weight: 600; color: var(--dark-brown);">Bank details updated</div>
                        <div style="color: var(--muted-rose); font-size: 0.9rem;">Account number changed ‚Ä¢ Admin User ‚Ä¢ Jan 18, 2024</div>
                    </div>
                    <span class="status-completed">Completed</span>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--off-white); border-radius: 8px;">
                    <div>
                        <div style="font-weight: 600; color: var(--dark-brown);">Referral bonus increased</div>
                        <div style="color: var(--muted-rose); font-size: 0.9rem;">KES 200 ‚Üí KES 300 ‚Ä¢ Admin User ‚Ä¢ Jan 15, 2024</div>
                    </div>
                    <span class="status-completed">Completed</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Security Notice -->
    <section class="premium-container">
        <div class="payment-notice">
            <h3 style="margin-bottom: 1rem;">üîí Security Notice</h3>
            <p style="margin: 0;">
                All changes to payment settings are logged and require admin authentication. 
                Please verify all information before saving changes. Test payment functionality 
                after making updates to ensure everything works correctly.
            </p>
        </div>
    </section>

    <!-- Premium Footer -->
    <footer class="premium-footer">
        <div class="footer-content">
            <div>
                <h3>Payment Settings</h3>
                <p>Secure Configuration</p>
                <p>Email: crowntradeacademy@gmail.com</p>
            </div>
            <div>
                <h3>Quick Access</h3>
                <p><a href="admin-dashboard.html" style="color: var(--warm-beige); text-decoration: none;">Admin Dashboard</a></p>
                <p><a href="#bank" style="color: var(--warm-beige); text-decoration: none;">Bank Details</a></p>
                <p><a href="#pricing" style="color: var(--warm-beige); text-decoration: none;">Pricing Settings</a></p>
            </div>
            <div>
                <h3>System</h3>
                <p>Settings Protected</p>
                <p>Change History Logged</p>
                <p>Auto-Backup Enabled</p>
            </div>
        </div>
        <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--muted-rose);">
            <p>&copy; 2024 Crown Trade Academy. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Update payment preview
        function updatePaymentPreview() {
            const activeMethod = document.getElementById('activePaymentMethod').value;
            const mpesaNumber = document.getElementById('mpesaNumber').value;
            const tillNumber = document.getElementById('tillNumber').value;
            const paybillNumber = document.getElementById('paybillNumber').value;
            const accountFormat = document.getElementById('accountFormat').value;
            
            const sampleAccount = generateAccountNumber('TEST123', accountFormat);
            let previewHTML = '';

            switch(activeMethod) {
                case 'phone':
                    previewHTML = `
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--dark-brown); font-size: 1.1rem;">üì± MPesa to Phone Number</strong>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Send to:</strong> ${mpesaNumber}
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Reference:</strong> ${sampleAccount}
                        </div>
                        <div style="background: var(--cream-white); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                            <strong>Client Instructions:</strong><br>
                            1. Go to <strong>MPesa</strong> on your phone<br>
                            2. Select <strong>"Send Money"</strong><br>
                            3. Enter phone: <strong>${mpesaNumber}</strong><br>
                            4. Enter amount as required<br>
                            5. Use reference: <strong>${sampleAccount}</strong><br>
                            6. Enter your MPesa PIN
                        </div>
                    `;
                    break;
                    
                case 'till':
                    previewHTML = `
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--dark-brown); font-size: 1.1rem;">üè™ Till Number</strong>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Till Number:</strong> ${tillNumber}
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Reference:</strong> ${sampleAccount}
                        </div>
                        <div style="background: var(--cream-white); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                            <strong>Client Instructions:</strong><br>
                            1. Go to <strong>MPesa</strong> on your phone<br>
                            2. Select <strong>"Lipa Na MPesa"</strong><br>
                            3. Select <strong>"Buy Goods & Services"</strong><br>
                            4. Enter Till: <strong>${tillNumber}</strong><br>
                            5. Enter amount as required<br>
                            6. Use reference: <strong>${sampleAccount}</strong><br>
                            7. Enter your MPesa PIN
                        </div>
                    `;
                    break;
                    
                case 'paybill':
                    previewHTML = `
                        <div style="margin-bottom: 1rem;">
                            <strong style="color: var(--dark-brown); font-size: 1.1rem;">üè¶ PayBill Number</strong>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>PayBill:</strong> ${paybillNumber}
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Account Number:</strong> ${sampleAccount}
                        </div>
                        <div style="background: var(--cream-white); padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                            <strong>Client Instructions:</strong><br>
                            1. Go to <strong>MPesa</strong> on your phone<br>
                            2. Select <strong>"Lipa Na MPesa"</strong><br>
                            3. Select <strong>"PayBill"</strong><br>
                            4. Business No: <strong>${paybillNumber}</strong><br>
                            5. Account No: <strong>${sampleAccount}</strong><br>
                            6. Enter amount as required<br>
                            7. Enter your MPesa PIN
                        </div>
                    `;
                    break;
            }
            
            document.getElementById('previewContent').innerHTML = previewHTML;
            updateCurrentMethodDisplay(activeMethod);
        }

        // Generate account number
        function generateAccountNumber(userId, format) {
            return format.replace('{USER_ID}', userId)
                         .replace('{TIMESTAMP}', Date.now().toString().slice(-6))
                         .replace('{RANDOM}', Math.random().toString(36).substr(2, 5).toUpperCase());
        }

        // Update current method display
        function updateCurrentMethodDisplay(method) {
            const methodNames = {
                'phone': 'üì± MPesa to Phone',
                'till': 'üè™ Till Number',
                'paybill': 'üè¶ PayBill Number'
            };
            document.getElementById('currentMethodDisplay').textContent = methodNames[method] || 'Unknown Method';
        }

        // Load payment settings
        function loadPaymentSettings() {
            const saved = localStorage.getItem('paymentSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                
                // Load flexible payment settings
                if (settings.flexiblePayment) {
                    document.getElementById('activePaymentMethod').value = settings.flexiblePayment.activeMethod || 'phone';
                    document.getElementById('mpesaNumber').value = settings.flexiblePayment.mpesaNumber || '+254712345678';
                    document.getElementById('tillNumber').value = settings.flexiblePayment.tillNumber || '123456';
                    document.getElementById('paybillNumber').value = settings.flexiblePayment.paybillNumber || '123456';
                    document.getElementById('accountFormat').value = settings.flexiblePayment.accountFormat || 'CTA{USER_ID}';
                }
                
                // Update preview
                updatePaymentPreview();
            }
        }

        // Save payment settings
        document.getElementById('paymentSettingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Collect flexible payment settings
            const flexibleSettings = {
                activeMethod: document.getElementById('activePaymentMethod').value,
                mpesaNumber: document.getElementById('mpesaNumber').value,
                tillNumber: document.getElementById('tillNumber').value,
                paybillNumber: document.getElementById('paybillNumber').value,
                accountFormat: document.getElementById('accountFormat').value
            };
            
            // Collect all form data
            const settings = {
                bankDetails: {
                    bankName: document.getElementById('bankName').value,
                    accountName: document.getElementById('accountName').value,
                    accountNumber: document.getElementById('accountNumber').value,
                    branch: document.getElementById('branch').value,
                    swiftCode: document.getElementById('swiftCode').value
                },
                flexiblePayment: flexibleSettings,
                pricing: {
                    registrationFee: document.getElementById('registrationFee').value,
                    mentorshipFee: document.getElementById('mentorshipFee').value,
                    advancedFee: document.getElementById('advancedFee').value,
                    premiumFee: document.getElementById('premiumFee').value
                },
                referral: {
                    referralBonus: document.getElementById('referralBonus').value,
                    minWithdrawal: document.getElementById('minWithdrawal').value
                },
                instructions: {
                    contactEmail: document.getElementById('contactEmail').value,
                    verificationMessage: document.getElementById('verificationMessage').value
                }
            };
            
            // Save to localStorage
            localStorage.setItem('paymentSettings', JSON.stringify(settings));
            
            alert('‚úÖ Payment settings saved successfully!\n\nActive Payment Method: ' + 
                  document.getElementById('currentMethodDisplay').textContent +
                  '\nAll changes have been applied across the platform.');
            
            // Log the change
            logChange('Payment settings updated - Method: ' + flexibleSettings.activeMethod);
        });

        // Reset to default values
        function resetToDefault() {
            if (confirm('Reset all payment settings to default values?')) {
                // Bank Details
                document.getElementById('bankName').value = 'Standard Chartered Bank Kenya';
                document.getElementById('accountName').value = 'Crown Trade Academy';
                document.getElementById('accountNumber').value = '0100000000000';
                document.getElementById('branch').value = 'Westlands Branch';
                document.getElementById('swiftCode').value = 'SCBLKENX';
                
                // Flexible Payment Methods
                document.getElementById('activePaymentMethod').value = 'phone';
                document.getElementById('mpesaNumber').value = '+254712345678';
                document.getElementById('tillNumber').value = '123456';
                document.getElementById('paybillNumber').value = '123456';
                document.getElementById('accountFormat').value = 'CTA{USER_ID}';
                
                // Pricing
                document.getElementById('registrationFee').value = '500';
                document.getElementById('mentorshipFee').value = '50000';
                document.getElementById('advancedFee').value = '75000';
                document.getElementById('premiumFee').value = '120000';
                
                // Referral System
                document.getElementById('referralBonus').value = '300';
                document.getElementById('minWithdrawal').value = '100';
                
                // Instructions
                document.getElementById('contactEmail').value = 'crowntradeacademy@gmail.com';
                document.getElementById('verificationMessage').value = 'Kindly before payment contact us through our email crowntradeacademy@gmail.com for verification and payment instructions. All transactions require verification for security purposes.';
                
                // Update preview
                updatePaymentPreview();
                
                alert('üîÑ All settings reset to default values!');
                logChange('Settings reset to default');
            }
        }

        // Test payment system
        function testPaymentSystem() {
            const activeMethod = document.getElementById('activePaymentMethod').value;
            alert('üß™ Payment system test initiated...\n\n' +
                  '‚úÖ Bank details validated\n' +
                  '‚úÖ ' + document.getElementById('currentMethodDisplay').textContent + ' configured\n' +
                  '‚úÖ Pricing structure verified\n' +
                  '‚úÖ Referral system active\n\n' +
                  'All systems operational!');
        }

        // Log changes (simulated)
        function logChange(description) {
            const logEntry = {
                description: description,
                timestamp: new Date().toLocaleString(),
                user: 'Admin User'
            };
            console.log('Change logged:', logEntry);
        }

        function logoutAdmin() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminUser');
                localStorage.removeItem('adminRole');
                localStorage.removeItem('adminName');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
