// Replace the entire script in admin-referral-approvals.html with this:

<script>
    // Admin auth check
    if (localStorage.getItem('adminLoggedIn') !== 'true') {
        window.location.href = 'admin-login.html';
    }

    let currentApplicationId = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadPendingApplications();
        loadApprovalHistory();
        updateStats();
    });

    function loadPendingApplications() {
        const applications = JSON.parse(localStorage.getItem('pendingApprovals') || '[]');
        const applicationsList = document.getElementById('applicationsList');
        
        document.getElementById('pendingCount').textContent = applications.length;
        document.getElementById('pendingApplications').textContent = applications.length;

        if (applications.length === 0) {
            applicationsList.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: var(--muted-rose);">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üì≠</div>
                    <h3>No Pending Applications</h3>
                    <p>All applications have been processed.</p>
                </div>
            `;
            return;
        }

        let applicationsHTML = '';
        applications.forEach((app, index) => {
            const submitDate = new Date(app.submittedAt).toLocaleDateString();
            
            applicationsHTML += `
                <div class="application-card" style="background: var(--off-white); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; border: 2px solid var(--light-taupe);">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 50px; height: 50px; background: var(--warm-beige); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--dark-brown);">
                                    ${app.userName ? app.userName.charAt(0).toUpperCase() : 'U'}
                                </div>
                                <div>
                                    <div style="font-weight: 700; color: var(--dark-brown); font-size: 1.1rem;">${app.userName || 'Unknown User'}</div>
                                    <div style="color: var(--muted-rose); font-size: 0.9rem;">${app.userEmail} ‚Ä¢ ${app.userPhone}</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--muted-rose);">Payment Reference</div>
                                    <div style="font-weight: 600; color: var(--dark-brown);">${app.paymentReference}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--muted-rose);">Amount Paid</div>
                                    <div style="font-weight: 600; color: var(--dark-brown);">KES ${app.amount.toLocaleString()}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.8rem; color: var(--muted-rose);">Submitted</div>
                                    <div style="font-weight: 600; color: var(--dark-brown);">${submitDate}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-premium" onclick="reviewApplication('${app.id}')">üëÅÔ∏è Review</button>
                            <button class="btn-success" onclick="quickApprove('${app.id}')">‚úÖ Approve</button>
                            <button class="btn-danger" onclick="quickReject('${app.id}')">‚ùå Reject</button>
                        </div>
                    </div>
                </div>
            `;
        });

        applicationsList.innerHTML = applicationsHTML;
    }

    function loadApprovalHistory() {
        const history = JSON.parse(localStorage.getItem('approvalHistory') || '[]');
        const historyTable = document.getElementById('approvalHistory');
        
        if (history.length === 0) {
            historyTable.innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--muted-rose); padding: 2rem;">No approval history yet.</td></tr>`;
            return;
        }

        const recentHistory = history.slice(-10).reverse();
        let historyHTML = '';
        
        recentHistory.forEach(record => {
            const actionDate = new Date(record.processedAt).toLocaleDateString();
            
            historyHTML += `
                <tr>
                    <td style="font-weight: 600; color: var(--dark-brown);">${record.userName}</td>
                    <td style="color: var(--muted-rose);">${actionDate}</td>
                    <td><span class="status-badge ${record.status === 'approved' ? 'status-approved' : 'status-rejected'}">${record.status}</span></td>
                    <td style="color: var(--muted-rose);">${record.processedBy}</td>
                    <td><button class="btn-action btn-view" onclick="viewHistoryDetails('${record.id}')">üìã Details</button></td>
                </tr>
            `;
        });

        historyTable.innerHTML = historyHTML;
    }

    function updateStats() {
        const pendingApps = JSON.parse(localStorage.getItem('pendingApprovals') || '[]');
        const history = JSON.parse(localStorage.getItem('approvalHistory') || '[]');
        const today = new Date().toDateString();
        
        const approvedToday = history.filter(record => 
            record.status === 'approved' && 
            new Date(record.processedAt).toDateString() === today
        ).length;
        
        const rejectedToday = history.filter(record => 
            record.status === 'rejected' && 
            new Date(record.processedAt).toDateString() === today
        ).length;

        const totalRevenue = history
            .filter(record => record.status === 'approved')
            .reduce((sum, record) => sum + (record.amount || 500), 0);

        document.getElementById('approvedToday').textContent = approvedToday;
        document.getElementById('rejectedToday').textContent = rejectedToday;
        document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();
    }

    function reviewApplication(applicationId) {
        const applications = JSON.parse(localStorage.getItem('pendingApprovals') || '[]');
        const application = applications.find(app => app.id === applicationId);
        
        if (!application) {
            alert('Application not found!');
            return;
        }

        currentApplicationId = applicationId;
        const submitDate = new Date(application.submittedAt).toLocaleString();
        
        document.getElementById('applicationDetails').innerHTML = `
            <div style="background: var(--off-white); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">Applicant Information</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div><strong>Full Name:</strong><br><span style="color: var(--muted-rose);">${application.userName}</span></div>
                    <div><strong>Email:</strong><br><span style="color: var(--muted-rose);">${application.userEmail}</span></div>
                    <div><strong>Phone:</strong><br><span style="color: var(--muted-rose);">${application.userPhone}</span></div>
                    <div><strong>Submitted:</strong><br><span style="color: var(--muted-rose);">${submitDate}</span></div>
                </div>
            </div>
            
            <div style="background: var(--off-white); padding: 1.5rem; border-radius: 8px;">
                <h3 style="color: var(--dark-brown); margin-bottom: 1rem;">Payment Details</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div><strong>Payment Reference:</strong><br><span style="color: var(--muted-rose);">${application.paymentReference}</span></div>
                    <div><strong>Amount Paid:</strong><br><span style="color: var(--muted-rose);">KES ${application.amount.toLocaleString()}</span></div>
                </div>
            </div>
        `;

        document.getElementById('approvalModal').style.display = 'flex';
    }

    function quickApprove(applicationId) {
        if (confirm('Approve this application?')) {
            approveApplication(applicationId);
        }
    }

    function quickReject(applicationId) {
        currentApplicationId = applicationId;
        document.getElementById('rejectionModal').style.display = 'flex';
    }

    function approveApplication(applicationId = null) {
        const appId = applicationId || currentApplicationId;
        const applications = JSON.parse(localStorage.getItem('pendingApprovals') || '[]');
        const application = applications.find(app => app.id === appId);
        
        if (!application) {
            alert('Application not found!');
            return;
        }

        // Remove from pending
        const updatedApplications = applications.filter(app => app.id !== appId);
        localStorage.setItem('pendingApprovals', JSON.stringify(updatedApplications));

        // Add to approval history
        const history = JSON.parse(localStorage.getItem('approvalHistory') || '[]');
        const adminName = localStorage.getItem('adminName') || 'Administrator';
        
        history.push({
            ...application,
            status: 'approved',
            processedAt: new Date().toISOString(),
            processedBy: adminName
        });
        
        localStorage.setItem('approvalHistory', JSON.stringify(history));

        // Activate user referral access
        activateReferralAccess(application);

        // Send notification
        sendApprovalNotification(application.userEmail, application.userName);

        closeModal('approvalModal');
        loadPendingApplications();
        loadApprovalHistory();
        updateStats();
        
        alert('‚úÖ Application approved! User notified.');
    }

    function activateReferralAccess(application) {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const user = users.find(u => u.email === application.userEmail);
        
        if (user) {
            user.package = 'referral-only';
            user.referralApproved = true;
            user.referralApprovalDate = new Date().toISOString();
            localStorage.setItem('users', JSON.stringify(users));
        }

        const referralData = JSON.parse(localStorage.getItem('referralData') || '{}');
        referralData[application.userEmail] = {
            totalEarnings: 0,
            totalReferrals: 0,
            successfulReferrals: 0,
            pendingEarnings: 0,
            referralHistory: [],
            joinDate: new Date().toISOString()
        };
        localStorage.setItem('referralData', JSON.stringify(referralData));
    }

    function sendApprovalNotification(userEmail, userName) {
        const notifications = JSON.parse(localStorage.getItem('userNotifications') || '{}');
        const userNotifications = notifications[userEmail] || [];
        
        userNotifications.unshift({
            id: 'notif_' + Date.now(),
            type: 'referral_approved',
            title: 'Referral Program Approved',
            message: 'Your referral program application has been approved!',
            timestamp: new Date().toISOString(),
            read: false
        });
        
        notifications[userEmail] = userNotifications;
        localStorage.setItem('userNotifications', JSON.stringify(notifications));
    }

    function rejectApplication() {
        document.getElementById('rejectionModal').style.display = 'flex';
    }

    function confirmRejection() {
        const rejectionReason = document.getElementById('rejectionReason').value.trim();
        
        if (!rejectionReason) {
            alert('Please provide a rejection reason.');
            return;
        }

        const applications = JSON.parse(localStorage.getItem('pendingApprovals') || '[]');
        const application = applications.find(app => app.id === currentApplicationId);
        
        if (!application) {
            alert('Application not found!');
            return;
        }

        const updatedApplications = applications.filter(app => app.id !== currentApplicationId);
        localStorage.setItem('pendingApprovals', JSON.stringify(updatedApplications));

        const history = JSON.parse(localStorage.getItem('approvalHistory') || '[]');
        const adminName = localStorage.getItem('adminName') || 'Administrator';
        
        history.push({
            ...application,
            status: 'rejected',
            processedAt: new Date().toISOString(),
            processedBy: adminName,
            rejectionReason: rejectionReason
        });
        
        localStorage.setItem('approvalHistory', JSON.stringify(history));

        closeModal('rejectionModal');
        document.getElementById('rejectionReason').value = '';
        loadPendingApplications();
        loadApprovalHistory();
        updateStats();
        
        alert('‚ùå Application rejected.');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function refreshApplications() {
        loadPendingApplications();
        loadApprovalHistory();
        updateStats();
        alert('üîÑ Refreshed!');
    }

    function logoutAdmin() {
        if (confirm('Logout?')) {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminName');
            localStorage.removeItem('adminRole');
            window.location.href = 'index.html';
        }
    }

    window.onclick = function(event) {
        const modals = document.getElementsByClassName('modal');
        for (let modal of modals) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    }
</script>
