<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Referral Approvals</title>
<link rel="stylesheet" href="style.css">
<style>
  body{font-family:Arial,sans-serif;background:#f5f5f5;margin:0;}
  .premium-header{background:#3a2d28;padding:1rem;}
  .premium-header .premium-nav{display:flex;justify-content:space-between;align-items:center;}
  .premium-header .premium-nav a.logo{color:#d4af37;font-weight:bold;text-decoration:none;font-size:1.2rem;}
  .premium-container{max-width:1000px;margin:3rem auto;padding:2rem;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  table{width:100%;border-collapse:collapse;}
  th,td{padding:0.75rem;text-align:left;border-bottom:1px solid #ccc;}
  th{background:#3a2d28;color:#d4af37;}
  .btn-approve{background:#28a745;color:#fff;padding:0.3rem 0.7rem;border:none;border-radius:6px;cursor:pointer;margin-right:0.5rem;}
  .btn-reject{background:#dc3545;color:#fff;padding:0.3rem 0.7rem;border:none;border-radius:6px;cursor:pointer;}
</style>
</head>
<body>

<header class="premium-header">
  <nav class="premium-nav">
    <a href="admin-dashboard.html" class="logo">Crown Trade Academy - Admin</a>
  </nav>
</header>

<section class="premium-container">
  <h1>Referral Approvals</h1>

  <table>
    <thead>
      <tr>
        <th>Applicant Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Referrer</th>
        <th>Status</th>
        <th>Applied At</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="referralsTable"></tbody>
  </table>
</section>

<script>
let referrals = JSON.parse(localStorage.getItem('referral_applications') || '[]');
let users = JSON.parse(localStorage.getItem('users') || '[]');

function updateTable(){
  const tbody = document.getElementById('referralsTable');
  tbody.innerHTML = '';
  referrals.forEach((r, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.fullName}</td>
      <td>${r.email}</td>
      <td>${r.phone}</td>
      <td>${r.referralCode || 'None'}</td>
      <td>${r.status}</td>
      <td>${new Date(r.submittedAt).toLocaleString()}</td>
      <td>
        ${r.status==='pending'? 
          `<button class="btn-approve" onclick="approveReferral(${index})">Approve</button>
           <button class="btn-reject" onclick="rejectReferral(${index})">Reject</button>` : ''
        }
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function approveReferral(index){
  const referral = referrals[index];
  referral.status = 'approved';

  // Update user
  const user = users.find(u => u.email === referral.email);
  if(user){
    user.status = 'approved';
    user.approvedAt = new Date().toISOString();
  }

  // Credit referrer
  if(referral.referralCode){
    const referrer = users.find(u => u.userReferralCode === referral.referralCode && u.status==='approved');
    if(referrer){
      referrer.balance += 300; // Referrer bonus
      users.find(u => u.email === 'business@cta.com').balance += 200; // Business receives 200 KES (ensure a business account exists)
    }
  }

  localStorage.setItem('referral_applications', JSON.stringify(referrals));
  localStorage.setItem('users', JSON.stringify(users));
  updateTable();
  alert('Referral approved and bonuses applied!');
}

function rejectReferral(index){
  const referral = referrals[index];
  referral.status = 'rejected';

  const user = users.find(u => u.email === referral.email);
  if(user){
    user.status = 'rejected';
  }

  localStorage.setItem('referral_applications', JSON.stringify(referrals));
  localStorage.setItem('users', JSON.stringify(users));
  updateTable();
  alert('Referral rejected.');
}

updateTable();
</script>

</body>
</html>
